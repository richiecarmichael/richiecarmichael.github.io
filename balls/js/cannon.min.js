!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof define&&!1)define([],n);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self);t.CANNON=n()}}(function(){return function n(t,i,r){function u(f,o){var h,s;if(!i[f]){if(!t[f]){if(h=typeof require=="function"&&require,!o&&h)return h(f,!0);if(e)return e(f,!0);throw new Error("Cannot find module '"+f+"'");}s=i[f]={exports:{}};t[f][0].call(s.exports,function(n){var i=t[f][1][n];return u(i?i:n)},s,s.exports,n,t,i,r)}return i[f].exports}for(var e=typeof require=="function"&&require,f=0;f<r.length;f++)u(r[f]);return u}({1:[function(n,t){t.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(n,t){t.exports={version:n("../package.json").version,AABB:n("./collision/AABB"),ArrayCollisionMatrix:n("./collision/ArrayCollisionMatrix"),Body:n("./objects/Body"),Box:n("./shapes/Box"),Broadphase:n("./collision/Broadphase"),Constraint:n("./constraints/Constraint"),ContactEquation:n("./equations/ContactEquation"),Narrowphase:n("./world/Narrowphase"),ConeTwistConstraint:n("./constraints/ConeTwistConstraint"),ContactMaterial:n("./material/ContactMaterial"),ConvexPolyhedron:n("./shapes/ConvexPolyhedron"),Cylinder:n("./shapes/Cylinder"),DistanceConstraint:n("./constraints/DistanceConstraint"),Equation:n("./equations/Equation"),EventTarget:n("./utils/EventTarget"),FrictionEquation:n("./equations/FrictionEquation"),GSSolver:n("./solver/GSSolver"),GridBroadphase:n("./collision/GridBroadphase"),Heightfield:n("./shapes/Heightfield"),HingeConstraint:n("./constraints/HingeConstraint"),LockConstraint:n("./constraints/LockConstraint"),Mat3:n("./math/Mat3"),Material:n("./material/Material"),NaiveBroadphase:n("./collision/NaiveBroadphase"),ObjectCollisionMatrix:n("./collision/ObjectCollisionMatrix"),Pool:n("./utils/Pool"),Particle:n("./shapes/Particle"),Plane:n("./shapes/Plane"),PointToPointConstraint:n("./constraints/PointToPointConstraint"),Quaternion:n("./math/Quaternion"),Ray:n("./collision/Ray"),RaycastVehicle:n("./objects/RaycastVehicle"),RaycastResult:n("./collision/RaycastResult"),RigidVehicle:n("./objects/RigidVehicle"),RotationalEquation:n("./equations/RotationalEquation"),RotationalMotorEquation:n("./equations/RotationalMotorEquation"),SAPBroadphase:n("./collision/SAPBroadphase"),SPHSystem:n("./objects/SPHSystem"),Shape:n("./shapes/Shape"),Solver:n("./solver/Solver"),Sphere:n("./shapes/Sphere"),SplitSolver:n("./solver/SplitSolver"),Spring:n("./objects/Spring"),Trimesh:n("./shapes/Trimesh"),Vec3:n("./math/Vec3"),Vec3Pool:n("./utils/Vec3Pool"),World:n("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(n,t){function r(n){n=n||{};this.lowerBound=new i;n.lowerBound&&this.lowerBound.copy(n.lowerBound);this.upperBound=new i;n.upperBound&&this.upperBound.copy(n.upperBound)}var i=n("../math/Vec3"),e=n("../utils/Utils"),u,f;t.exports=r;u=new i;r.prototype.setFromPoints=function(n,t,i,r){var f=this.lowerBound,o=this.upperBound,s=i,h,e;for(f.copy(n[0]),s&&s.vmult(f,f),o.copy(f),h=1;h<n.length;h++)e=n[h],s&&(s.vmult(e,u),e=u),e.x>o.x&&(o.x=e.x),e.x<f.x&&(f.x=e.x),e.y>o.y&&(o.y=e.y),e.y<f.y&&(f.y=e.y),e.z>o.z&&(o.z=e.z),e.z<f.z&&(f.z=e.z);return t&&(t.vadd(f,f),t.vadd(o,o)),r&&(f.x-=r,f.y-=r,f.z-=r,o.x+=r,o.y+=r,o.z+=r),this};r.prototype.copy=function(n){return this.lowerBound.copy(n.lowerBound),this.upperBound.copy(n.upperBound),this};r.prototype.clone=function(){return(new r).copy(this)};r.prototype.extend=function(n){var i=n.lowerBound.x,t;this.lowerBound.x>i&&(this.lowerBound.x=i);t=n.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);i=n.lowerBound.y;this.lowerBound.y>i&&(this.lowerBound.y=i);t=n.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);i=n.lowerBound.z;this.lowerBound.z>i&&(this.lowerBound.z=i);t=n.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)};r.prototype.overlaps=function(n){var r=this.lowerBound,t=this.upperBound,u=n.lowerBound,i=n.upperBound;return(u.x<=t.x&&t.x<=i.x||r.x<=i.x&&i.x<=t.x)&&(u.y<=t.y&&t.y<=i.y||r.y<=i.y&&i.y<=t.y)&&(u.z<=t.z&&t.z<=i.z||r.z<=i.z&&i.z<=t.z)};r.prototype.contains=function(n){var t=this.lowerBound,i=this.upperBound,r=n.lowerBound,u=n.upperBound;return t.x<=r.x&&i.x>=u.x&&t.y<=r.y&&i.y>=u.y&&t.z<=r.z&&i.z>=u.z};r.prototype.getCorners=function(n,t,i,r,u,f,e,o){var s=this.lowerBound,h=this.upperBound;n.copy(s);t.set(h.x,s.y,s.z);i.set(h.x,h.y,s.z);r.set(s.x,h.y,h.z);u.set(h.x,s.y,s.z);f.set(s.x,h.y,s.z);e.set(s.x,s.y,h.z);o.copy(h)};f=[new i,new i,new i,new i,new i,new i,new i,new i];r.prototype.toLocalFrame=function(n,t){var i=f,e=i[0],o=i[1],s=i[2],h=i[3],c=i[4],l=i[5],a=i[6],v=i[7],r,u;for(this.getCorners(e,o,s,h,c,l,a,v),r=0;r!==8;r++)u=i[r],n.pointToLocal(u,u);return t.setFromPoints(i)};r.prototype.toWorldFrame=function(n,t){var i=f,e=i[0],o=i[1],s=i[2],h=i[3],c=i[4],l=i[5],a=i[6],v=i[7],r,u;for(this.getCorners(e,o,s,h,c,l,a,v),r=0;r!==8;r++)u=i[r],n.pointToWorld(u,u);return t.setFromPoints(i)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(n,t){function i(){this.matrix=[]}t.exports=i;i.prototype.get=function(n,t){if(n=n.index,t=t.index,t>n){var i=t;t=n;n=i}return this.matrix[(n*(n+1)>>1)+t-1]};i.prototype.set=function(n,t,i){if(n=n.index,t=t.index,t>n){var r=t;t=n;n=r}this.matrix[(n*(n+1)>>1)+t-1]=i?1:0};i.prototype.reset=function(){for(var n=0,t=this.matrix.length;n!==t;n++)this.matrix[n]=0};i.prototype.setNumObjects=function(n){this.matrix.length=n*(n-1)>>1}},{}],5:[function(n,t){function i(){this.world=null;this.useBoundingBoxes=!1;this.dirty=!0}var r=n("../objects/Body"),u=n("../math/Vec3"),o=n("../math/Quaternion"),a=n("../shapes/Shape"),v=n("../shapes/Plane"),f,e;t.exports=i;i.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!");};f=r.STATIC|r.KINEMATIC;i.prototype.needBroadphaseCollision=function(n,t){return(n.collisionFilterGroup&t.collisionFilterMask)==0||(t.collisionFilterGroup&n.collisionFilterMask)==0?!1:((n.type&f)!=0||n.sleepState===r.SLEEPING)&&((t.type&f)!=0||t.sleepState===r.SLEEPING)?!1:!0};i.prototype.intersectionTest=function(n,t,i,r){this.useBoundingBoxes?this.doBoundingBoxBroadphase(n,t,i,r):this.doBoundingSphereBroadphase(n,t,i,r)};var s=new u,y=new u,p=new o,w=new u;i.prototype.doBoundingSphereBroadphase=function(n,t,i,r){var u=s,f,e;t.position.vsub(n.position,u);f=Math.pow(n.boundingRadius+t.boundingRadius,2);e=u.norm2();e<f&&(i.push(n),r.push(t))};i.prototype.doBoundingBoxBroadphase=function(n,t,i,r){n.aabbNeedsUpdate&&n.computeAABB();t.aabbNeedsUpdate&&t.computeAABB();n.aabb.overlaps(t.aabb)&&(i.push(n),r.push(t))};var h={keys:[]},c=[],l=[];i.prototype.makePairsUnique=function(n,t){for(var u,a,r=h,f=c,e=l,v=n.length,i=0;i!==v;i++)f[i]=n[i],e[i]=t[i];for(n.length=0,t.length=0,i=0;i!==v;i++){var o=f[i].id,s=e[i].id,u=o<s?o+","+s:s+","+o;r[u]=i;r.keys.push(u)}for(i=0;i!==r.keys.length;i++)u=r.keys.pop(),a=r[u],n.push(f[a]),t.push(e[a]),delete r[u]};i.prototype.setWorld=function(){};e=new u;i.boundingSphereCheck=function(n,t){var i=e;return n.position.vsub(t.position,i),Math.pow(n.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()};i.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(n,t){function i(n,t,i,f,e){var o,s;if(u.apply(this),this.nx=i||10,this.ny=f||10,this.nz=e||10,this.aabbMin=n||new r(100,100,100),this.aabbMax=t||new r(-100,-100,-100),o=this.nx*this.ny*this.nz,o<=0)throw"GridBroadphase: Each dimension's n must be >0";for(this.bins=[],this.binLengths=[],this.bins.length=o,this.binLengths.length=o,s=0;s<o;s++)this.bins[s]=[],this.binLengths[s]=0}var f,o;t.exports=i;var u=n("./Broadphase"),r=n("../math/Vec3"),e=n("../shapes/Shape");i.prototype=new u;i.prototype.constructor=i;f=new r;o=new r;i.prototype.collisionPairs=function(n,t,i){function ri(n,t,i,r,u,f,e){var h=(n-p)*gt|0,l=(t-w)*ni|0,a=(i-b)*ti|0,v=st((r-p)*gt),y=st((u-w)*ni),k=st((f-b)*ti),tt,it,rt,ft;for(h<0?h=0:h>=c&&(h=c-1),l<0?l=0:l>=s&&(l=s-1),a<0?a=0:a>=o&&(a=o-1),v<0?v=0:v>=c&&(v=c-1),y<0?y=0:y>=s&&(y=s-1),k<0?k=0:k>=o&&(k=o-1),h*=d,l*=g,a*=nt,v*=d,y*=g,k*=nt,tt=h;tt<=v;tt+=d)for(it=l;it<=y;it+=g)for(rt=a;rt<=k;rt+=nt)ft=tt+it+rt,ot[ft][ut[ft]++]=e}for(var v,ht,ct,lt,at,vt,yt,pt,h,r,a,wt,hi=n.numObjects(),ci=n.bodies,ft=this.aabbMax,et=this.aabbMin,c=this.nx,s=this.ny,o=this.nz,d=s*o,g=o,nt=1,bt=ft.x,kt=ft.y,dt=ft.z,p=et.x,w=et.y,b=et.z,gt=c/(bt-p),ni=s/(kt-w),ti=o/(dt-b),tt=(bt-p)/c,it=(kt-w)/s,rt=(dt-b)/o,li=Math.sqrt(tt*tt+it*it+rt*rt)*.5,k=e.types,ai=k.SPHERE,vi=k.PLANE,wi=k.BOX,bi=k.COMPOUND,ki=k.CONVEXPOLYHEDRON,ot=this.bins,ut=this.binLengths,ii=this.bins.length,u=0;u!==ii;u++)ut[u]=0;var st=Math.ceil,et=Math.min,ft=Math.max;for(u=0;u!==hi;u++){r=ci[u];v=r.shape;switch(v.type){case ai:var ui=r.position.x,fi=r.position.y,ei=r.position.z,y=v.radius;ri(ui-y,fi-y,ei-y,ui+y,fi+y,ei+y,r);break;case vi:v.worldNormalNeedsUpdate&&v.computeWorldNormal(r.quaternion);var yi=v.worldNormal,pi=p+tt*.5-r.position.x,oi=w+it*.5-r.position.y,si=b+rt*.5-r.position.z,l=f;for(l.set(pi,oi,si),h=0,ht=0;h!==c;h++,ht+=d,l.y=oi,l.x+=tt)for(a=0,ct=0;a!==s;a++,ct+=g,l.z=si,l.y+=it)for(lt=0,at=0;lt!==o;lt++,at+=nt,l.z+=rt)l.dot(yi)<li&&(vt=ht+ct+at,ot[vt][ut[vt]++]=r);break;default:r.aabbNeedsUpdate&&r.computeAABB();ri(r.aabb.lowerBound.x,r.aabb.lowerBound.y,r.aabb.lowerBound.z,r.aabb.upperBound.x,r.aabb.upperBound.y,r.aabb.upperBound.z,r)}}for(u=0;u!==ii;u++)if(yt=ut[u],yt>1)for(pt=ot[u],h=0;h!==yt;h++)for(r=pt[h],a=0;a!==h;a++)wt=pt[a],this.needBroadphaseCollision(r,wt)&&this.intersectionTest(r,wt,t,i);this.makePairsUnique(t,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(n,t){function i(){r.apply(this)}var r,u,f;t.exports=i;r=n("./Broadphase");u=n("./AABB");i.prototype=new r;i.prototype.constructor=i;i.prototype.collisionPairs=function(n,t,i){for(var f=n.bodies,s=f.length,u,e,o,r=0;r!==s;r++)for(u=0;u!==r;u++)(e=f[r],o=f[u],this.needBroadphaseCollision(e,o))&&this.intersectionTest(e,o,t,i)};f=new u;i.prototype.aabbQuery=function(n,t,i){var u,r;for(i=i||[],u=0;u<n.bodies.length;u++)r=n.bodies[u],r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r);return i}},{"./AABB":3,"./Broadphase":5}],8:[function(n,t){function i(){this.matrix={}}t.exports=i;i.prototype.get=function(n,t){if(n=n.id,t=t.id,t>n){var i=t;t=n;n=i}return n+"-"+t in this.matrix};i.prototype.set=function(n,t,i){if(n=n.id,t=t.id,t>n){var r=t;t=n;n=r}i?this.matrix[n+"-"+t]=!0:delete this.matrix[n+"-"+t]};i.prototype.reset=function(){this.matrix={}};i.prototype.setNumObjects=function(){}},{}],9:[function(n,t){function i(n,t){this.from=n?n.clone():new r;this.to=t?t.clone():new r;this._direction=new r;this.precision=.0001;this.checkCollisionResponse=!0;this.skipBackfaces=!1;this.collisionFilterMask=-1;this.collisionFilterGroup=-1;this.mode=i.ANY;this.result=new w;this.hasHit=!1;this.callback=function(){}}function a(n,t,i,r){r.vsub(t,h);i.vsub(t,l);n.vsub(t,p);var f=h.dot(h),u=h.dot(l),e=h.dot(p),o=l.dot(l),s=l.dot(p),c,a;return(c=o*e-u*s)>=0&&(a=f*s-u*e)>=0&&c+a<f*o-u*u}function bt(n,t,i){var r;return i.vsub(n,h),r=h.dot(t),t.mult(r,v),v.vadd(n,v),i.distanceTo(v)}var b,y,l,p,g,nt,k,tt,it,h,v;t.exports=i;var r=n("../math/Vec3"),et=n("../math/Quaternion"),e=n("../math/Transform"),kt=n("../shapes/ConvexPolyhedron"),dt=n("../shapes/Box"),w=n("../collision/RaycastResult"),c=n("../shapes/Shape"),d=n("../collision/AABB");i.prototype.constructor=i;i.CLOSEST=1;i.ANY=2;i.ALL=4;b=new d;y=[];i.prototype.intersectWorld=function(n,t){return this.mode=t.mode||i.ANY,this.result=t.result||new w,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=typeof t.collisionFilterMask!="undefined"?t.collisionFilterMask:-1,this.collisionFilterGroup=typeof t.collisionFilterGroup!="undefined"?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(b),y.length=0,n.broadphase.aabbQuery(n,b,y),this.intersectBodies(y),this.hasHit};l=new r;p=new r;i.pointInTriangle=a;g=new r;nt=new et;i.prototype.intersectBody=function(n,t){var u,r,f,i,o,e;if((t&&(this.result=t,this._updateDirection()),u=this.checkCollisionResponse,!u||n.collisionResponse)&&(this.collisionFilterGroup&n.collisionFilterMask)!=0&&(n.collisionFilterGroup&this.collisionFilterMask)!=0)for(r=g,f=nt,i=0,o=n.shapes.length;i<o;i++)if((e=n.shapes[i],!u||e.collisionResponse)&&(n.quaternion.mult(n.shapeOrientations[i],f),n.quaternion.vmult(n.shapeOffsets[i],r),r.vadd(n.position,r),this.intersectShape(e,f,r,n),this.result._shouldStop))break};i.prototype.intersectBodies=function(n,t){t&&(this.result=t,this._updateDirection());for(var i=0,r=n.length;!this.result._shouldStop&&i<r;i++)this.intersectBody(n[i])};i.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction);this._direction.normalize()};i.prototype.intersectShape=function(n,t,i,r){var f=this.from,e=bt(f,this._direction,i),u;e>n.boundingSphereRadius||(u=this[n.type],u&&u.call(this,n,t,i,r))};var gt=new r,ni=new r,u=new r,f=new r,o=new r,s=new r,ti=new r,ii=new w;i.prototype.intersectBox=function(n,t,i,r){return this.intersectConvex(n.convexPolyhedronRepresentation,t,i,r)};i.prototype[c.types.BOX]=i.prototype.intersectBox;i.prototype.intersectPlane=function(n,t,i,u){var o=this.from,c=this.to,l=this._direction,f=new r(0,0,1),e,s,a,h,w;if((t.vmult(f,f),e=new r,o.vsub(i,e),s=e.dot(f),c.vsub(i,e),a=e.dot(f),!(s*a>0))&&!(o.distanceTo(c)<s)&&(h=f.dot(l),!(Math.abs(h)<this.precision))){var v=new r,y=new r,p=new r;o.vsub(i,v);w=-f.dot(v)/h;l.scale(w,y);o.vadd(y,p);this.reportIntersection(f,p,n,u,-1)}};i.prototype[c.types.PLANE]=i.prototype.intersectPlane;i.prototype.getAABB=function(n){var t=this.to,i=this.from;n.lowerBound.x=Math.min(t.x,i.x);n.lowerBound.y=Math.min(t.y,i.y);n.lowerBound.z=Math.min(t.z,i.z);n.upperBound.x=Math.max(t.x,i.x);n.upperBound.y=Math.max(t.y,i.y);n.upperBound.z=Math.max(t.z,i.z)};k={faceList:[0]};i.prototype.intersectHeightfield=function(n,t,u,f){var nt=n.data,tt=n.elementSize,p=new r,s=new i(this.from,this.to),w,d,g,v,y;e.pointToLocalFrame(u,t,s.from,s.from);e.pointToLocalFrame(u,t,s.to,s.to);var o=[],h=null,c=null,l=null,a=null,b=n.getIndexOfPosition(s.from.x,s.from.y,o,!1);if(b&&(h=o[0],c=o[1],l=o[0],a=o[1]),b=n.getIndexOfPosition(s.to.x,s.to.y,o,!1),b&&((h===null||o[0]<h)&&(h=o[0]),(l===null||o[0]>l)&&(l=o[0]),(c===null||o[1]<c)&&(c=o[1]),(a===null||o[1]>a)&&(a=o[1])),h!==null)for(w=[],n.getRectMinMax(h,c,l,a,w),d=w[0],g=w[1],v=h;v<=l;v++)for(y=c;y<=a;y++){if(this.result._shouldStop)return;if(n.getConvexTrianglePillar(v,y,!1),e.pointToWorldFrame(u,t,n.pillarOffset,p),this.intersectConvex(n.pillarConvex,t,p,f,k),this.result._shouldStop)return;n.getConvexTrianglePillar(v,y,!0);e.pointToWorldFrame(u,t,n.pillarOffset,p);this.intersectConvex(n.pillarConvex,t,p,f,k)}};i.prototype[c.types.HEIGHTFIELD]=i.prototype.intersectHeightfield;tt=new r;it=new r;i.prototype.intersectSphere=function(n,t,i,r){var u=this.from,f=this.to,v=n.radius,l=Math.pow(f.x-u.x,2)+Math.pow(f.y-u.y,2)+Math.pow(f.z-u.z,2),a=2*((f.x-u.x)*(u.x-i.x)+(f.y-u.y)*(u.y-i.y)+(f.z-u.z)*(u.z-i.z)),y=Math.pow(u.x-i.x,2)+Math.pow(u.y-i.y,2)+Math.pow(u.z-i.z,2)-Math.pow(v,2),s=Math.pow(a,2)-4*l*y,e=tt,o=it,h,c;if(!(s<0))if(s===0)u.lerp(f,s,e),e.vsub(i,o),o.normalize(),this.reportIntersection(o,e,n,r,-1);else{if(h=(-a-Math.sqrt(s))/(2*l),c=(-a+Math.sqrt(s))/(2*l),h>=0&&h<=1&&(u.lerp(f,h,e),e.vsub(i,o),o.normalize(),this.reportIntersection(o,e,n,r,-1)),this.result._shouldStop)return;c>=0&&c<=1&&(u.lerp(f,c,e),e.vsub(i,o),o.normalize(),this.reportIntersection(o,e,n,r,-1))}};i.prototype[c.types.SPHERE]=i.prototype.intersectSphere;var ot=new r,rt=new r,ut=new r,ft=new r;i.prototype.intersectConvex=function(n,t,i,r,e){for(var nt,tt,v,ht,pt=rt,y=ot,h=ft,wt=ut,p=e&&e.faceList||null,it=n.faces,w=n.vertices,ct=n.faceNormals,et=this._direction,b=this.from,lt=this.to,at=b.distanceTo(lt),vt=p?p.length:it.length,st=this.result,k=0;!st._shouldStop&&k<vt;k++){var g=p?p[k]:k,c=it[g],yt=ct[g],l=t,d=i;if((h.copy(w[c[0]]),l.vmult(h,h),h.vadd(d,h),h.vsub(b,h),l.vmult(yt,y),nt=et.dot(y),!(Math.abs(nt)<this.precision))&&(tt=y.dot(h)/nt,!(tt<0)))for(et.mult(tt,u),u.vadd(b,u),f.copy(w[c[0]]),l.vmult(f,f),d.vadd(f,f),v=1;!st._shouldStop&&v<c.length-1;v++)(o.copy(w[c[v]]),s.copy(w[c[v+1]]),l.vmult(o,o),l.vmult(s,s),d.vadd(o,o),d.vadd(s,s),ht=u.distanceTo(b),!a(u,f,o,s)&&!a(u,o,f,s)||ht>at)||this.reportIntersection(y,u,n,r,g)}};i.prototype[c.types.CONVEXPOLYHEDRON]=i.prototype.intersectConvex;var st=new r,ht=new r,ct=new r,lt=new r,at=new r,vt=new r,yt=new d,pt=[],wt=new e;i.prototype.intersectTrimesh=function(n,t,i,r,h){var v=st,y=pt,w=wt,ti=rt,g=ft,ii=ut,ri=yt,b=ht,l=ct,nt=lt,tt=vt,it=at,ui=h&&h.faceList||null,k=n.indices,fi=n.vertices,ei=n.faceNormals,dt=this.from,gt=this.to,ni=this._direction,et,p,ot,c,bt,d,kt;for(w.position.copy(i),w.quaternion.copy(t),e.vectorToLocalFrame(i,t,ni,b),e.pointToLocalFrame(i,t,dt,l),e.pointToLocalFrame(i,t,gt,nt),et=l.distanceSquared(nt),n.tree.rayQuery(this,w,y),p=0,ot=y.length;!this.result._shouldStop&&p!==ot;p++)(c=y[p],n.getNormal(c,v),n.getVertex(k[c*3],f),f.vsub(l,g),bt=b.dot(v),d=v.dot(g)/bt,d<0)||(b.scale(d,u),u.vadd(l,u),n.getVertex(k[c*3+1],o),n.getVertex(k[c*3+2],s),kt=u.distanceSquared(l),!a(u,o,f,s)&&!a(u,f,o,s)||kt>et)||(e.vectorToWorldFrame(t,v,it),e.pointToWorldFrame(i,t,u,tt),this.reportIntersection(it,tt,n,r,c));y.length=0};i.prototype[c.types.TRIMESH]=i.prototype.intersectTrimesh;i.prototype.reportIntersection=function(n,t,r,u,f){var o=this.from,h=this.to,s=o.distanceTo(t),e=this.result;if(!this.skipBackfaces||!(n.dot(this._direction)>0)){e.hitFaceIndex=typeof f!="undefined"?f:-1;switch(this.mode){case i.ALL:this.hasHit=!0;e.set(o,h,n,t,r,u,s);e.hasHit=!0;this.callback(e);break;case i.CLOSEST:(s<e.distance||!e.hasHit)&&(this.hasHit=!0,e.hasHit=!0,e.set(o,h,n,t,r,u,s));break;case i.ANY:this.hasHit=!0;e.hasHit=!0;e.set(o,h,n,t,r,u,s);e._shouldStop=!0}}};h=new r;v=new r},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(n,t){function r(){this.rayFromWorld=new i;this.rayToWorld=new i;this.hitNormalWorld=new i;this.hitPointWorld=new i;this.hasHit=!1;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=!1}var i=n("../math/Vec3");t.exports=r;r.prototype.reset=function(){this.rayFromWorld.setZero();this.rayToWorld.setZero();this.hitNormalWorld.setZero();this.hitPointWorld.setZero();this.hasHit=!1;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=!1};r.prototype.abort=function(){this._shouldStop=!0};r.prototype.set=function(n,t,i,r,u,f,e){this.rayFromWorld.copy(n);this.rayToWorld.copy(t);this.hitNormalWorld.copy(i);this.hitPointWorld.copy(r);this.shape=u;this.body=f;this.distance=e}},{"../math/Vec3":30}],11:[function(n,t){function i(n){r.apply(this);this.axisList=[];this.world=null;this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(n){t.push(n.body)};this._removeBodyHandler=function(n){var i=t.indexOf(n.body);i!==-1&&t.splice(i,1)};n&&this.setWorld(n)}var u=n("../shapes/Shape"),r=n("../collision/Broadphase");t.exports=i;i.prototype=new r;i.prototype.setWorld=function(n){this.axisList.length=0;for(var t=0;t<n.bodies.length;t++)this.axisList.push(n.bodies[t]);n.removeEventListener("addBody",this._addBodyHandler);n.removeEventListener("removeBody",this._removeBodyHandler);n.addEventListener("addBody",this._addBodyHandler);n.addEventListener("removeBody",this._removeBodyHandler);this.world=n;this.dirty=!0};i.insertionSortX=function(n){for(var r,t,i=1,u=n.length;i<u;i++){for(r=n[i],t=i-1;t>=0;t--){if(n[t].aabb.lowerBound.x<=r.aabb.lowerBound.x)break;n[t+1]=n[t]}n[t+1]=r}return n};i.insertionSortY=function(n){for(var r,t,i=1,u=n.length;i<u;i++){for(r=n[i],t=i-1;t>=0;t--){if(n[t].aabb.lowerBound.y<=r.aabb.lowerBound.y)break;n[t+1]=n[t]}n[t+1]=r}return n};i.insertionSortZ=function(n){for(var r,t,i=1,u=n.length;i<u;i++){for(r=n[i],t=i-1;t>=0;t--){if(n[t].aabb.lowerBound.z<=r.aabb.lowerBound.z)break;n[t+1]=n[t]}n[t+1]=r}return n};i.prototype.collisionPairs=function(n,t,r){var s=this.axisList,h=s.length,c=this.axisIndex,u,f,e,o;for(this.dirty&&(this.sortList(),this.dirty=!1),u=0;u!==h;u++)for(e=s[u],f=u+1;f<h;f++)if(o=s[f],this.needBroadphaseCollision(e,o)){if(!i.checkBounds(e,o,c))break;this.intersectionTest(e,o,t,r)}};i.prototype.sortList=function(){for(var u,n=this.axisList,t=this.axisIndex,f=n.length,r=0;r!==f;r++)u=n[r],u.aabbNeedsUpdate&&u.computeAABB();t===0?i.insertionSortX(n):t===1?i.insertionSortY(n):t===2&&i.insertionSortZ(n)};i.checkBounds=function(n,t,i){var r,u;i===0?(r=n.position.x,u=t.position.x):i===1?(r=n.position.y,u=t.position.y):i===2&&(r=n.position.z,u=t.position.z);var f=n.boundingRadius,e=t.boundingRadius,h=r-f,o=r+f,s=u-e,c=u+e;return s<o};i.prototype.autoDetectAxis=function(){for(var n,t,i,r,u=0,h=0,f=0,c=0,e=0,l=0,a=this.axisList,v=a.length,o=1/v,s=0;s!==v;s++)n=a[s],t=n.position.x,u+=t,h+=t*t,i=n.position.y,f+=i,c+=i*i,r=n.position.z,e+=r,l+=r*r;var y=h-u*u*o,p=c-f*f*o,w=l-e*e*o;this.axisIndex=y>p?y>w?0:2:p>w?1:2};i.prototype.aabbQuery=function(n,t,i){var e,r,f,u;i=i||[];this.dirty&&(this.sortList(),this.dirty=!1);e=this.axisIndex;r="x";e===1&&(r="y");e===2&&(r="z");var o=this.axisList,s=t.lowerBound[r],h=t.upperBound[r];for(f=0;f<o.length;f++)u=o[f],u.aabbNeedsUpdate&&u.computeAABB(),u.aabb.overlaps(t)&&i.push(u);return i}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(n,t){function r(n,t,r){var o,s;r=r||{};var h=typeof r.maxForce!="undefined"?r.maxForce:1e6,c=r.pivotA?r.pivotA.clone():new i,l=r.pivotB?r.pivotB.clone():new i;this.axisA=r.axisA?r.axisA.clone():new i;this.axisB=r.axisB?r.axisB.clone():new i;u.call(this,n,c,t,l,h);this.collideConnected=!!r.collideConnected;this.angle=typeof r.angle!="undefined"?r.angle:0;o=this.coneEquation=new f(n,t,r);s=this.twistEquation=new e(n,t,r);this.twistAngle=typeof r.twistAngle!="undefined"?r.twistAngle:0;o.maxForce=0;o.minForce=-h;s.maxForce=0;s.minForce=-h;this.equations.push(o,s)}var o,s;t.exports=r;var h=n("./Constraint"),u=n("./PointToPointConstraint"),f=n("../equations/ConeEquation"),e=n("../equations/RotationalEquation"),c=n("../equations/ContactEquation"),i=n("../math/Vec3");r.prototype=new u;r.constructor=r;o=new i;s=new i;r.prototype.update=function(){var i=this.bodyA,r=this.bodyB,t=this.coneEquation,n=this.twistEquation;u.prototype.update.call(this);i.vectorToWorldFrame(this.axisA,t.axisA);r.vectorToWorldFrame(this.axisB,t.axisB);this.axisA.tangents(n.axisA,n.axisA);i.vectorToWorldFrame(n.axisA,n.axisA);this.axisB.tangents(n.axisB,n.axisB);r.vectorToWorldFrame(n.axisB,n.axisB);t.angle=this.angle;n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(n,t){function i(n,t,u){u=r.defaults(u,{collideConnected:!0,wakeUpBodies:!0});this.equations=[];this.bodyA=n;this.bodyB=t;this.id=i.idCounter++;this.collideConnected=u.collideConnected;u.wakeUpBodies&&(n&&n.wakeUp(),t&&t.wakeUp())}t.exports=i;var r=n("../utils/Utils");i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!");};i.prototype.enable=function(){for(var t=this.equations,n=0;n<t.length;n++)t[n].enabled=!0};i.prototype.disable=function(){for(var t=this.equations,n=0;n<t.length;n++)t[n].enabled=!1};i.idCounter=0},{"../utils/Utils":53}],14:[function(n,t){function i(n,t,i,f){r.call(this,n,t);typeof i=="undefined"&&(i=n.position.distanceTo(t.position));typeof f=="undefined"&&(f=1e6);this.distance=i;var e=this.distanceEquation=new u(n,t);this.equations.push(e);e.minForce=-f;e.maxForce=f}t.exports=i;var r=n("./Constraint"),u=n("../equations/ContactEquation");i.prototype=new r;i.prototype.update=function(){var r=this.bodyA,u=this.bodyB,t=this.distanceEquation,i=this.distance*.5,n=t.ni;u.position.vsub(r.position,n);n.normalize();n.mult(i,t.ri);n.mult(-i,t.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(n,t){function i(n,t,i){var o,h;i=i||{};var e=typeof i.maxForce!="undefined"?i.maxForce:1e6,l=i.pivotA?i.pivotA.clone():new r,a=i.pivotB?i.pivotB.clone():new r;u.call(this,n,l,t,a,e);o=this.axisA=i.axisA?i.axisA.clone():new r(1,0,0);o.normalize();h=this.axisB=i.axisB?i.axisB.clone():new r(1,0,0);h.normalize();var v=this.rotationalEquation1=new f(n,t,i),y=this.rotationalEquation2=new f(n,t,i),c=this.motorEquation=new s(n,t,e);c.enabled=!1;this.equations.push(v,y,c)}var e,o;t.exports=i;var h=n("./Constraint"),u=n("./PointToPointConstraint"),f=n("../equations/RotationalEquation"),s=n("../equations/RotationalMotorEquation"),c=n("../equations/ContactEquation"),r=n("../math/Vec3");i.prototype=new u;i.constructor=i;i.prototype.enableMotor=function(){this.motorEquation.enabled=!0};i.prototype.disableMotor=function(){this.motorEquation.enabled=!1};i.prototype.setMotorSpeed=function(n){this.motorEquation.targetVelocity=n};i.prototype.setMotorMaxForce=function(n){this.motorEquation.maxForce=n;this.motorEquation.minForce=-n};e=new r;o=new r;i.prototype.update=function(){var t=this.bodyA,i=this.bodyB,r=this.motorEquation,f=this.rotationalEquation1,s=this.rotationalEquation2,h=e,n=o,c=this.axisA,l=this.axisB;u.prototype.update.call(this);t.quaternion.vmult(c,h);i.quaternion.vmult(l,n);h.tangents(f.axisA,s.axisA);f.axisB.copy(n);s.axisB.copy(n);this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,r.axisA),i.quaternion.vmult(this.axisB,r.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(n,t){function r(n,t,r){r=r||{};var h=typeof r.maxForce!="undefined"?r.maxForce:1e6,o=new i,s=new i,e=new i;n.position.vadd(t.position,e);e.scale(.5,e);t.pointToLocalFrame(e,s);n.pointToLocalFrame(e,o);u.call(this,n,o,t,s,h);var c=this.rotationalEquation1=new f(n,t,r),l=this.rotationalEquation2=new f(n,t,r),a=this.rotationalEquation3=new f(n,t,r);this.equations.push(c,l,a)}var e,o;t.exports=r;var s=n("./Constraint"),u=n("./PointToPointConstraint"),f=n("../equations/RotationalEquation"),h=n("../equations/RotationalMotorEquation"),c=n("../equations/ContactEquation"),i=n("../math/Vec3");r.prototype=new u;r.constructor=r;e=new i;o=new i;r.prototype.update=function(){var n=this.bodyA,t=this.bodyB,h=this.motorEquation,r=this.rotationalEquation1,f=this.rotationalEquation2,s=this.rotationalEquation3,c=e,l=o;u.prototype.update.call(this);n.vectorToWorldFrame(i.UNIT_X,r.axisA);t.vectorToWorldFrame(i.UNIT_Y,r.axisB);n.vectorToWorldFrame(i.UNIT_Y,f.axisA);t.vectorToWorldFrame(i.UNIT_Z,f.axisB);n.vectorToWorldFrame(i.UNIT_Z,s.axisA);t.vectorToWorldFrame(i.UNIT_X,s.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(n,t){function r(n,t,r,e,o){u.call(this,n,r);o=typeof o!="undefined"?o:1e6;this.pivotA=t?t.clone():new f;this.pivotB=e?e.clone():new f;var s=this.equationX=new i(n,r),h=this.equationY=new i(n,r),c=this.equationZ=new i(n,r);this.equations.push(s,h,c);s.minForce=h.minForce=c.minForce=-o;s.maxForce=h.maxForce=c.maxForce=o;s.ni.set(1,0,0);h.ni.set(0,1,0);c.ni.set(0,0,1)}t.exports=r;var u=n("./Constraint"),i=n("../equations/ContactEquation"),f=n("../math/Vec3");r.prototype=new u;r.prototype.update=function(){var r=this.bodyA,u=this.bodyB,n=this.equationX,t=this.equationY,i=this.equationZ;r.quaternion.vmult(this.pivotA,n.ri);u.quaternion.vmult(this.pivotB,n.rj);t.ri.copy(n.ri);t.rj.copy(n.rj);i.ri.copy(n.ri);i.rj.copy(n.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(n,t){function i(n,t,i){i=i||{};var f=typeof i.maxForce!="undefined"?i.maxForce:1e6;u.call(this,n,t,-f,f);this.axisA=i.axisA?i.axisA.clone():new r(1,0,0);this.axisB=i.axisB?i.axisB.clone():new r(0,1,0);this.angle=typeof i.angle!="undefined"?i.angle:0}var f,e;t.exports=i;var r=n("../math/Vec3"),o=n("../math/Mat3"),u=n("./Equation");i.prototype=new u;i.prototype.constructor=i;f=new r;e=new r;i.prototype.computeB=function(n){var o=this.a,s=this.b,t=this.axisA,i=this.axisB,r=f,u=e,h=this.jacobianElementA,c=this.jacobianElementB;t.cross(i,r);i.cross(t,u);h.rotational.copy(u);c.rotational.copy(r);var l=Math.cos(this.angle)-t.dot(i),a=this.computeGW(),v=this.computeGiMf();return-l*o-a*s-n*v}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(n,t){function r(n,t,r){r=typeof r!="undefined"?r:1e6;u.call(this,n,t,0,r);this.restitution=0;this.ri=new i;this.rj=new i;this.ni=new i}t.exports=r;var u=n("./Equation"),i=n("../math/Vec3"),v=n("../math/Mat3");r.prototype=new u;r.prototype.constructor=r;var f=new i,e=new i,o=new i;r.prototype.computeB=function(n){var p=this.a,w=this.b,r=this.bi,u=this.bj,c=this.ri,l=this.rj,s=f,h=e,b=r.velocity,k=r.angularVelocity,rt=r.force,ut=r.torque,d=u.velocity,g=u.angularVelocity,ft=u.force,et=u.torque,t=o,a=this.jacobianElementA,v=this.jacobianElementB,i=this.ni;c.cross(i,s);l.cross(i,h);i.negate(a.spatial);s.negate(a.rotational);v.spatial.copy(i);v.rotational.copy(h);t.copy(u.position);t.vadd(l,t);t.vsub(r.position,t);t.vsub(c,t);var nt=i.dot(t),y=this.restitution+1,tt=y*d.dot(i)-y*b.dot(i)+g.dot(h)-k.dot(s),it=this.computeGiMf();return-nt*p-tt*w-n*it};var s=new i,h=new i,c=new i,l=new i,a=new i;r.prototype.getImpactVelocityAlongNormal=function(){var n=s,t=h,i=c,r=l,u=a;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,r),this.bi.getVelocityAtWorldPoint(i,n),this.bj.getVelocityAtWorldPoint(r,t),n.vsub(t,u),this.ni.dot(u)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(n,t){function i(n,t,r,u){this.id=i.id++;this.minForce=typeof r=="undefined"?-1e6:r;this.maxForce=typeof u=="undefined"?1e6:u;this.bi=n;this.bj=t;this.a=0;this.b=0;this.eps=0;this.jacobianElementA=new e;this.jacobianElementB=new e;this.enabled=!0;this.setSpookParams(1e7,4,1/60)}var e,r,u,f;t.exports=i;e=n("../math/JacobianElement");r=n("../math/Vec3");i.prototype.constructor=i;i.id=0;i.prototype.setSpookParams=function(n,t,i){var r=t,f=n,u=i;this.a=4/(u*(1+4*r));this.b=4*r/(1+4*r);this.eps=4/(u*u*f*(1+4*r))};i.prototype.computeB=function(n,t,i){var r=this.computeGW(),u=this.computeGq(),f=this.computeGiMf();return-u*n-r*t-f*i};i.prototype.computeGq=function(){var n=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,r=this.bj,u=i.position,f=r.position;return n.spatial.dot(u)+t.spatial.dot(f)};u=new r;i.prototype.computeGW=function(){var i=this.jacobianElementA,r=this.jacobianElementB,n=this.bi,t=this.bj,f=n.velocity,e=t.velocity,o=n.angularVelocity||u,s=t.angularVelocity||u;return i.multiplyVectors(f,o)+r.multiplyVectors(e,s)};i.prototype.computeGWlambda=function(){var i=this.jacobianElementA,r=this.jacobianElementB,n=this.bi,t=this.bj,f=n.vlambda,e=t.vlambda,o=n.wlambda||u,s=t.wlambda||u;return i.multiplyVectors(f,o)+r.multiplyVectors(e,s)};var h=new r,c=new r,o=new r,s=new r;i.prototype.computeGiMf=function(){var i=this.jacobianElementA,r=this.jacobianElementB,n=this.bi,t=this.bj,u=n.force,f=n.torque,e=t.force,l=t.torque,a=n.invMassSolve,v=t.invMassSolve;return n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(f,o):o.set(0,0,0),t.invInertiaWorldSolve?t.invInertiaWorldSolve.vmult(l,s):s.set(0,0,0),u.mult(a,h),e.mult(v,c),i.multiplyVectors(h,o)+r.multiplyVectors(c,s)};f=new r;i.prototype.computeGiMGt=function(){var t=this.jacobianElementA,i=this.jacobianElementB,r=this.bi,u=this.bj,s=r.invMassSolve,h=u.invMassSolve,e=r.invInertiaWorldSolve,o=u.invInertiaWorldSolve,n=s+h;return e&&(e.vmult(t.rotational,f),n+=f.dot(t.rotational)),o&&(o.vmult(i.rotational,f),n+=f.dot(i.rotational)),n};var l=new r,a=new r,v=new r,y=new r,p=new r,w=new r;i.prototype.addToWlambda=function(n){var u=this.jacobianElementA,f=this.jacobianElementB,i=this.bi,r=this.bj,t=l;u.spatial.mult(i.invMassSolve*n,t);i.vlambda.vadd(t,i.vlambda);f.spatial.mult(r.invMassSolve*n,t);r.vlambda.vadd(t,r.vlambda);i.invInertiaWorldSolve&&(i.invInertiaWorldSolve.vmult(u.rotational,t),t.mult(n,t),i.wlambda.vadd(t,i.wlambda));r.invInertiaWorldSolve&&(r.invInertiaWorldSolve.vmult(f.rotational,t),t.mult(n,t),r.wlambda.vadd(t,r.wlambda))};i.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(n,t){function r(n,t,r){u.call(this,n,t,-r,r);this.ri=new i;this.rj=new i;this.t=new i}var f,e;t.exports=r;var u=n("./Equation"),i=n("../math/Vec3"),o=n("../math/Mat3");r.prototype=new u;r.prototype.constructor=r;f=new i;e=new i;r.prototype.computeB=function(n){var v=this.a,s=this.b,y=this.bi,p=this.bj,h=this.ri,c=this.rj,u=f,o=e,t=this.t,i,r;h.cross(t,u);c.cross(t,o);i=this.jacobianElementA;r=this.jacobianElementB;t.negate(i.spatial);u.negate(i.rotational);r.spatial.copy(t);r.rotational.copy(o);var l=this.computeGW(),a=this.computeGiMf();return-l*s-n*a}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(n,t){function i(n,t,i){i=i||{};var f=typeof i.maxForce!="undefined"?i.maxForce:1e6;u.call(this,n,t,-f,f);this.axisA=i.axisA?i.axisA.clone():new r(1,0,0);this.axisB=i.axisB?i.axisB.clone():new r(0,1,0);this.maxAngle=Math.PI/2}var f,e;t.exports=i;var r=n("../math/Vec3"),o=n("../math/Mat3"),u=n("./Equation");i.prototype=new u;i.prototype.constructor=i;f=new r;e=new r;i.prototype.computeB=function(n){var o=this.a,s=this.b,t=this.axisA,i=this.axisB,r=f,u=e,h=this.jacobianElementA,c=this.jacobianElementB;t.cross(i,r);i.cross(t,u);h.rotational.copy(u);c.rotational.copy(r);var l=Math.cos(this.maxAngle)-t.dot(i),a=this.computeGW(),v=this.computeGiMf();return-l*o-a*s-n*v}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(n,t){function i(n,t,i){i=typeof i!="undefined"?i:1e6;u.call(this,n,t,-i,i);this.axisA=new r;this.axisB=new r;this.targetVelocity=0}t.exports=i;var r=n("../math/Vec3"),f=n("../math/Mat3"),u=n("./Equation");i.prototype=new u;i.prototype.constructor=i;i.prototype.computeB=function(n){var s=this.a,t=this.b,h=this.bi,c=this.bj,i=this.axisA,r=this.axisB,u=this.jacobianElementA,f=this.jacobianElementB;u.rotational.copy(i);r.negate(f.rotational);var e=this.computeGW()-this.targetVelocity,o=this.computeGiMf();return-e*t-n*o}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(n,t){function i(n,t,u){u=r.defaults(u,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3});this.id=i.idCounter++;this.materials=[n,t];this.friction=u.friction;this.restitution=u.restitution;this.contactEquationStiffness=u.contactEquationStiffness;this.contactEquationRelaxation=u.contactEquationRelaxation;this.frictionEquationStiffness=u.frictionEquationStiffness;this.frictionEquationRelaxation=u.frictionEquationRelaxation}var r=n("../utils/Utils");t.exports=i;i.idCounter=0},{"../utils/Utils":53}],25:[function(n,t){function i(n){var t="";n=n||{};typeof n=="string"?(t=n,n={}):typeof n=="object"&&(t="");this.name=t;this.id=i.idCounter++;this.friction=typeof n.friction!="undefined"?n.friction:-1;this.restitution=typeof n.restitution!="undefined"?n.restitution:-1}t.exports=i;i.idCounter=0},{}],26:[function(n,t){function i(){this.spatial=new r;this.rotational=new r}t.exports=i;var r=n("./Vec3");i.prototype.multiplyElement=function(n){return n.spatial.dot(this.spatial)+n.rotational.dot(this.rotational)};i.prototype.multiplyVectors=function(n,t){return n.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":30}],27:[function(n,t){function i(n){this.elements=n?n:[0,0,0,0,0,0,0,0,0]}t.exports=i;var r=n("./Vec3");i.prototype.identity=function(){var n=this.elements;n[0]=1;n[1]=0;n[2]=0;n[3]=0;n[4]=1;n[5]=0;n[6]=0;n[7]=0;n[8]=1};i.prototype.setZero=function(){var n=this.elements;n[0]=0;n[1]=0;n[2]=0;n[3]=0;n[4]=0;n[5]=0;n[6]=0;n[7]=0;n[8]=0};i.prototype.setTrace=function(n){var t=this.elements;t[0]=n.x;t[4]=n.y;t[8]=n.z};i.prototype.getTrace=function(n){var n=n||new r,t=this.elements;n.x=t[0];n.y=t[4];n.z=t[8]};i.prototype.vmult=function(n,t){t=t||new r;var i=this.elements,u=n.x,f=n.y,e=n.z;return t.x=i[0]*u+i[1]*f+i[2]*e,t.y=i[3]*u+i[4]*f+i[5]*e,t.z=i[6]*u+i[7]*f+i[8]*e,t};i.prototype.smult=function(n){for(var t=0;t<this.elements.length;t++)this.elements[t]*=n};i.prototype.mmult=function(n,t){for(var r,e,u,o=t||new i,f=0;f<3;f++)for(r=0;r<3;r++){for(e=0,u=0;u<3;u++)e+=n.elements[f+u*3]*this.elements[u+r*3];o.elements[f+r*3]=e}return o};i.prototype.scale=function(n,t){var u,f,r;for(t=t||new i,u=this.elements,f=t.elements,r=0;r!==3;r++)f[3*r+0]=n.x*u[3*r+0],f[3*r+1]=n.y*u[3*r+1],f[3*r+2]=n.z*u[3*r+2];return t};i.prototype.solve=function(n,t){var u,e,a;t=t||new r;var f=4,i=[];for(u=0;u<3*f;u++)i.push(0);for(u=0;u<3;u++)for(e=0;e<3;e++)i[u+f*e]=this.elements[u+3*e];i[3]=n.x;i[7]=n.y;i[11]=n.z;var c=3,l=c,s,h=4,o;do{if(u=l-c,i[u+f*u]===0)for(e=u+1;e<l;e++)if(i[u+f*e]!==0){s=h;do o=h-s,i[o+f*u]+=i[o+f*e];while(--s);break}if(i[u+f*u]!==0)for(e=u+1;e<l;e++){a=i[u+f*e]/i[u+f*u];s=h;do o=h-s,i[o+f*e]=o<=u?0:i[o+f*e]-i[o+f*u]*a;while(--s)}}while(--c);if(t.z=i[2*f+3]/i[2*f+2],t.y=(i[1*f+3]-i[1*f+2]*t.z)/i[1*f+1],t.x=(i[0*f+3]-i[0*f+2]*t.z-i[0*f+1]*t.y)/i[0*f+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===Infinity||t.y===Infinity||t.z===Infinity)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+n.toString()+"], A=["+this.toString()+"]";return t};i.prototype.e=function(n,t,i){if(i===undefined)return this.elements[t+3*n];this.elements[t+3*n]=i};i.prototype.copy=function(n){for(var t=0;t<n.elements.length;t++)this.elements[t]=n.elements[t];return this};i.prototype.toString=function(){for(var t="",n=0;n<9;n++)t+=this.elements[n]+",";return t};i.prototype.reverse=function(n){var t,f,s;n=n||new i;var a=3,u=6,r=[];for(t=0;t<a*u;t++)r.push(0);for(t=0;t<3;t++)for(f=0;f<3;f++)r[t+u*f]=this.elements[t+3*f];r[3]=1;r[9]=0;r[15]=0;r[4]=0;r[10]=1;r[16]=0;r[5]=0;r[11]=0;r[17]=1;var c=3,l=c,o,h=u,e;do{if(t=l-c,r[t+u*t]===0)for(f=t+1;f<l;f++)if(r[t+u*f]!==0){o=h;do e=h-o,r[e+u*t]+=r[e+u*f];while(--o);break}if(r[t+u*t]!==0)for(f=t+1;f<l;f++){s=r[t+u*f]/r[t+u*t];o=h;do e=h-o,r[e+u*f]=e<=t?0:r[e+u*f]-r[e+u*t]*s;while(--o)}}while(--c);t=2;do{f=t-1;do{s=r[t+u*f]/r[t+u*t];o=u;do e=u-o,r[e+u*f]=r[e+u*f]-r[e+u*t]*s;while(--o)}while(f--)}while(--t);t=2;do{s=1/r[t+u*t];o=u;do e=u-o,r[e+u*t]=r[e+u*t]*s;while(--o)}while(t--);t=2;do{f=2;do{if(e=r[a+f+u*t],isNaN(e)||e===Infinity)throw"Could not reverse! A=["+this.toString()+"]";n.e(t,f,e)}while(f--)}while(t--);return n};i.prototype.setRotationFromQuaternion=function(n){var i=n.x,r=n.y,f=n.z,e=n.w,s=i+i,o=r+r,u=f+f,h=i*s,c=i*o,l=i*u,a=r*o,v=r*u,y=f*u,p=e*s,w=e*o,b=e*u,t=this.elements;return t[0]=1-(a+y),t[1]=c-b,t[2]=l+w,t[3]=c+b,t[4]=1-(h+y),t[5]=v-p,t[6]=l-w,t[7]=v+p,t[8]=1-(h+a),this};i.prototype.transpose=function(n){var u,f,t,r;for(n=n||new i,u=n.elements,f=this.elements,t=0;t!==3;t++)for(r=0;r!==3;r++)u[3*t+r]=f[3*r+t];return n}},{"./Vec3":30}],28:[function(n,t){function i(n,t,i,r){this.x=n!==undefined?n:0;this.y=t!==undefined?t:0;this.z=i!==undefined?i:0;this.w=r!==undefined?r:1}var r,u,f;t.exports=i;r=n("./Vec3");i.prototype.set=function(n,t,i,r){this.x=n;this.y=t;this.z=i;this.w=r};i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w};i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]};i.prototype.setFromAxisAngle=function(n,t){var i=Math.sin(t*.5);this.x=n.x*i;this.y=n.y*i;this.z=n.z*i;this.w=Math.cos(t*.5)};i.prototype.toAxisAngle=function(n){n=n||new r;this.normalize();var i=2*Math.acos(this.w),t=Math.sqrt(1-this.w*this.w);return t<.001?(n.x=this.x,n.y=this.y,n.z=this.z):(n.x=this.x/t,n.y=this.y/t,n.z=this.z/t),[n,i]};u=new r;f=new r;i.prototype.setFromVectors=function(n,t){var r,e,i;n.isAntiparallelTo(t)?(r=u,e=f,n.tangents(r,e),this.setFromAxisAngle(r,Math.PI)):(i=n.cross(t),this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(n.norm(),2)*Math.pow(t.norm(),2))+n.dot(t),this.normalize())};var e=new r,o=new r,s=new r;i.prototype.mult=function(n,t){t=t||new i;var f=this.w,r=e,u=o,h=s;return r.set(this.x,this.y,this.z),u.set(n.x,n.y,n.z),t.w=f*n.w-r.dot(u),r.cross(u,h),t.x=f*u.x+n.w*r.x+h.x,t.y=f*u.y+n.w*r.y+h.y,t.z=f*u.z+n.w*r.z+h.z,t};i.prototype.inverse=function(n){var r=this.x,u=this.y,f=this.z,e=this.w,t;return n=n||new i,this.conjugate(n),t=1/(r*r+u*u+f*f+e*e),n.x*=t,n.y*=t,n.z*=t,n.w*=t,n};i.prototype.conjugate=function(n){return n=n||new i,n.x=-this.x,n.y=-this.y,n.z=-this.z,n.w=this.w,n};i.prototype.normalize=function(){var n=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);n===0?(this.x=0,this.y=0,this.z=0,this.w=0):(n=1/n,this.x*=n,this.y*=n,this.z*=n,this.w*=n)};i.prototype.normalizeFast=function(){var n=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;n===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=n,this.y*=n,this.z*=n,this.w*=n)};i.prototype.vmult=function(n,t){t=t||new r;var o=n.x,s=n.y,h=n.z,i=this.x,u=this.y,f=this.z,e=this.w,c=e*o+u*h-f*s,l=e*s+f*o-i*h,a=e*h+i*s-u*o,v=-i*o-u*s-f*h;return t.x=c*e+v*-i+l*-f-a*-u,t.y=l*e+v*-u+a*-i-c*-f,t.z=a*e+v*-f+c*-u-l*-i,t};i.prototype.copy=function(n){return this.x=n.x,this.y=n.y,this.z=n.z,this.w=n.w,this};i.prototype.toEuler=function(n,t){var h;t=t||"YZX";var r,o,s,i=this.x,u=this.y,f=this.z,e=this.w;switch(t){case"YZX":if(h=i*u+f*e,h>.499&&(r=2*Math.atan2(i,e),o=Math.PI/2,s=0),h<-.499&&(r=-2*Math.atan2(i,e),o=-Math.PI/2,s=0),isNaN(r)){var l=i*i,a=u*u,c=f*f;r=Math.atan2(2*u*e-2*i*f,1-2*a-2*c);o=Math.asin(2*h);s=Math.atan2(2*i*e-2*u*f,1-2*l-2*c)}break;default:throw new Error("Euler order "+t+" not supported yet.");}n.y=r;n.z=o;n.x=s};i.prototype.setFromEuler=function(n,t,i,r){r=r||"XYZ";var u=Math.cos(n/2),f=Math.cos(t/2),e=Math.cos(i/2),o=Math.sin(n/2),s=Math.sin(t/2),h=Math.sin(i/2);return r==="XYZ"?(this.x=o*f*e+u*s*h,this.y=u*s*e-o*f*h,this.z=u*f*h+o*s*e,this.w=u*f*e-o*s*h):r==="YXZ"?(this.x=o*f*e+u*s*h,this.y=u*s*e-o*f*h,this.z=u*f*h-o*s*e,this.w=u*f*e+o*s*h):r==="ZXY"?(this.x=o*f*e-u*s*h,this.y=u*s*e+o*f*h,this.z=u*f*h+o*s*e,this.w=u*f*e-o*s*h):r==="ZYX"?(this.x=o*f*e-u*s*h,this.y=u*s*e+o*f*h,this.z=u*f*h-o*s*e,this.w=u*f*e+o*s*h):r==="YZX"?(this.x=o*f*e+u*s*h,this.y=u*s*e+o*f*h,this.z=u*f*h-o*s*e,this.w=u*f*e-o*s*h):r==="XZY"&&(this.x=o*f*e-u*s*h,this.y=u*s*e-o*f*h,this.z=u*f*h+o*s*e,this.w=u*f*e+o*s*h),this};i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(n,t){function i(n){n=n||{};this.position=new r;n.position&&this.position.copy(n.position);this.quaternion=new f;n.quaternion&&this.quaternion.copy(n.quaternion)}var r=n("./Vec3"),f=n("./Quaternion"),u;t.exports=i;u=new f;i.pointToLocalFrame=function(n,t,i,f){var f=f||new r;return i.vsub(n,f),t.conjugate(u),u.vmult(f,f),f};i.prototype.pointToLocal=function(n,t){return i.pointToLocalFrame(this.position,this.quaternion,n,t)};i.pointToWorldFrame=function(n,t,i,u){var u=u||new r;return t.vmult(i,u),u.vadd(n,u),u};i.prototype.pointToWorld=function(n,t){return i.pointToWorldFrame(this.position,this.quaternion,n,t)};i.prototype.vectorToWorldFrame=function(n,t){var t=t||new r;return this.quaternion.vmult(n,t),t};i.vectorToWorldFrame=function(n,t,i){return n.vmult(t,i),i};i.vectorToLocalFrame=function(n,t,i,u){var u=u||new r;return t.w*=-1,t.vmult(i,u),t.w*=-1,u}},{"./Quaternion":28,"./Vec3":30}],30:[function(n,t){function i(n,t,i){this.x=n||0;this.y=t||0;this.z=i||0}var u,f,e,r;t.exports=i;u=n("./Mat3");i.ZERO=new i(0,0,0);i.UNIT_X=new i(1,0,0);i.UNIT_Y=new i(0,1,0);i.UNIT_Z=new i(0,0,1);i.prototype.cross=function(n,t){var r=n.x,u=n.y,f=n.z,e=this.x,o=this.y,s=this.z;return t=t||new i,t.x=o*f-s*u,t.y=s*r-e*f,t.z=e*u-o*r,t};i.prototype.set=function(n,t,i){return this.x=n,this.y=t,this.z=i,this};i.prototype.setZero=function(){this.x=this.y=this.z=0};i.prototype.vadd=function(n,t){if(t)t.x=n.x+this.x,t.y=n.y+this.y,t.z=n.z+this.z;else return new i(this.x+n.x,this.y+n.y,this.z+n.z)};i.prototype.vsub=function(n,t){if(t)t.x=this.x-n.x,t.y=this.y-n.y,t.z=this.z-n.z;else return new i(this.x-n.x,this.y-n.y,this.z-n.z)};i.prototype.crossmat=function(){return new u([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])};i.prototype.normalize=function(){var i=this.x,r=this.y,u=this.z,t=Math.sqrt(i*i+r*r+u*u),n;return t>0?(n=1/t,this.x*=n,this.y*=n,this.z*=n):(this.x=0,this.y=0,this.z=0),t};i.prototype.unit=function(n){n=n||new i;var r=this.x,u=this.y,f=this.z,t=Math.sqrt(r*r+u*u+f*f);return t>0?(t=1/t,n.x=r*t,n.y=u*t,n.z=f*t):(n.x=1,n.y=0,n.z=0),n};i.prototype.norm=function(){var n=this.x,t=this.y,i=this.z;return Math.sqrt(n*n+t*t+i*i)};i.prototype.length=i.prototype.norm;i.prototype.norm2=function(){return this.dot(this)};i.prototype.lengthSquared=i.prototype.norm2;i.prototype.distanceTo=function(n){var t=this.x,i=this.y,r=this.z,u=n.x,f=n.y,e=n.z;return Math.sqrt((u-t)*(u-t)+(f-i)*(f-i)+(e-r)*(e-r))};i.prototype.distanceSquared=function(n){var t=this.x,i=this.y,r=this.z,u=n.x,f=n.y,e=n.z;return(u-t)*(u-t)+(f-i)*(f-i)+(e-r)*(e-r)};i.prototype.mult=function(n,t){t=t||new i;var r=this.x,u=this.y,f=this.z;return t.x=n*r,t.y=n*u,t.z=n*f,t};i.prototype.scale=i.prototype.mult;i.prototype.dot=function(n){return this.x*n.x+this.y*n.y+this.z*n.z};i.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0};i.prototype.negate=function(n){return n=n||new i,n.x=-this.x,n.y=-this.y,n.z=-this.z,n};f=new i;e=new i;i.prototype.tangents=function(n,t){var o=this.norm(),i,u,r;o>0?(i=f,u=1/o,i.set(this.x*u,this.y*u,this.z*u),r=e,Math.abs(i.x)<.9?(r.set(1,0,0),i.cross(r,n)):(r.set(0,1,0),i.cross(r,n)),i.cross(n,t)):(n.set(1,0,0),t.set(0,1,0))};i.prototype.toString=function(){return this.x+","+this.y+","+this.z};i.prototype.toArray=function(){return[this.x,this.y,this.z]};i.prototype.copy=function(n){return this.x=n.x,this.y=n.y,this.z=n.z,this};i.prototype.lerp=function(n,t,i){var r=this.x,u=this.y,f=this.z;i.x=r+(n.x-r)*t;i.y=u+(n.y-u)*t;i.z=f+(n.z-f)*t};i.prototype.almostEquals=function(n,t){return(t===undefined&&(t=1e-6),Math.abs(this.x-n.x)>t||Math.abs(this.y-n.y)>t||Math.abs(this.z-n.z)>t)?!1:!0};i.prototype.almostZero=function(n){return(n===undefined&&(n=1e-6),Math.abs(this.x)>n||Math.abs(this.y)>n||Math.abs(this.z)>n)?!1:!0};r=new i;i.prototype.isAntiparallelTo=function(n,t){return this.negate(r),r.almostEquals(n,t)};i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(n,t){function i(n){n=n||{};e.apply(this);this.id=i.idCounter++;this.world=null;this.preStep=null;this.postStep=null;this.vlambda=new r;this.collisionFilterGroup=typeof n.collisionFilterGroup=="number"?n.collisionFilterGroup:1;this.collisionFilterMask=typeof n.collisionFilterMask=="number"?n.collisionFilterMask:1;this.collisionResponse=!0;this.position=new r;n.position&&this.position.copy(n.position);this.previousPosition=new r;this.initPosition=new r;this.velocity=new r;n.velocity&&this.velocity.copy(n.velocity);this.initVelocity=new r;this.force=new r;var t=typeof n.mass=="number"?n.mass:0;this.mass=t;this.invMass=t>0?1/t:0;this.material=n.material||null;this.linearDamping=typeof n.linearDamping=="number"?n.linearDamping:.01;this.type=t<=0?i.STATIC:i.DYNAMIC;typeof n.type==typeof i.STATIC&&(this.type=n.type);this.allowSleep=typeof n.allowSleep!="undefined"?n.allowSleep:!0;this.sleepState=0;this.sleepSpeedLimit=typeof n.sleepSpeedLimit!="undefined"?n.sleepSpeedLimit:.1;this.sleepTimeLimit=typeof n.sleepTimeLimit!="undefined"?n.sleepTimeLimit:1;this.timeLastSleepy=0;this._wakeUpAfterNarrowphase=!1;this.torque=new r;this.quaternion=new f;n.quaternion&&this.quaternion.copy(n.quaternion);this.initQuaternion=new f;this.angularVelocity=new r;n.angularVelocity&&this.angularVelocity.copy(n.angularVelocity);this.initAngularVelocity=new r;this.interpolatedPosition=new r;this.interpolatedQuaternion=new f;this.shapes=[];this.shapeOffsets=[];this.shapeOrientations=[];this.inertia=new r;this.invInertia=new r;this.invInertiaWorld=new u;this.invMassSolve=0;this.invInertiaSolve=new r;this.invInertiaWorldSolve=new u;this.fixedRotation=typeof n.fixedRotation!="undefined"?n.fixedRotation:!1;this.angularDamping=typeof n.angularDamping!="undefined"?n.angularDamping:.01;this.aabb=new o;this.aabbNeedsUpdate=!0;this.wlambda=new r;n.shape&&this.addShape(n.shape);this.updateMassProperties()}var s,h,c,l,a,v,y,p,w,b;t.exports=i;var e=n("../utils/EventTarget"),ut=n("../shapes/Shape"),r=n("../math/Vec3"),u=n("../math/Mat3"),f=n("../math/Quaternion"),ft=n("../material/Material"),o=n("../collision/AABB"),k=n("../shapes/Box");i.prototype=new e;i.prototype.constructor=i;i.DYNAMIC=1;i.STATIC=2;i.KINEMATIC=4;i.AWAKE=0;i.SLEEPY=1;i.SLEEPING=2;i.idCounter=0;i.prototype.wakeUp=function(){var n=this.sleepState;this.sleepState=0;n===i.SLEEPING&&this.dispatchEvent({type:"wakeup"})};i.prototype.sleep=function(){this.sleepState=i.SLEEPING;this.velocity.set(0,0,0);this.angularVelocity.set(0,0,0)};i.sleepyEvent={type:"sleepy"};i.sleepEvent={type:"sleep"};i.prototype.sleepTick=function(n){if(this.allowSleep){var t=this.sleepState,r=this.velocity.norm2()+this.angularVelocity.norm2(),u=Math.pow(this.sleepSpeedLimit,2);t===i.AWAKE&&r<u?(this.sleepState=i.SLEEPY,this.timeLastSleepy=n,this.dispatchEvent(i.sleepyEvent)):t===i.SLEEPY&&r>u?this.wakeUp():t===i.SLEEPY&&n-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(i.sleepEvent))}};i.prototype.updateSolveMassProperties=function(){this.sleepState===i.SLEEPING||this.type===i.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))};i.prototype.pointToLocalFrame=function(n,t){var t=t||new r;return n.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t};i.prototype.vectorToLocalFrame=function(n,t){var t=t||new r;return this.quaternion.conjugate().vmult(n,t),t};i.prototype.pointToWorldFrame=function(n,t){var t=t||new r;return this.quaternion.vmult(n,t),t.vadd(this.position,t),t};i.prototype.vectorToWorldFrame=function(n,t){var t=t||new r;return this.quaternion.vmult(n,t),t};s=new r;h=new f;i.prototype.addShape=function(n,t,i){var u=new r,e=new f;return t&&u.copy(t),i&&e.copy(i),this.shapes.push(n),this.shapeOffsets.push(u),this.shapeOrientations.push(e),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this};i.prototype.updateBoundingRadius=function(){for(var i,r,u,f=this.shapes,e=this.shapeOffsets,o=f.length,t=0,n=0;n!==o;n++)i=f[n],i.updateBoundingSphereRadius(),r=e[n].norm(),u=i.boundingSphereRadius,r+u>t&&(t=r+u);this.boundingRadius=t};c=new o;i.prototype.computeAABB=function(){for(var e,u=this.shapes,o=this.shapeOffsets,l=this.shapeOrientations,a=u.length,t=s,r=h,v=this.quaternion,f=this.aabb,i=c,n=0;n!==a;n++)e=u[n],l[n].mult(v,r),r.vmult(o[n],t),t.vadd(this.position,t),e.calculateWorldAABB(t,r,i.lowerBound,i.upperBound),n===0?f.copy(i):f.extend(i);this.aabbNeedsUpdate=!1};var d=new u,g=new u,nt=new u;i.prototype.updateInertiaWorld=function(n){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||n){var i=d,r=g,u=nt;i.setRotationFromQuaternion(this.quaternion);i.transpose(r);i.scale(t,i);i.mmult(r,this.invInertiaWorld)}};l=new r;a=new r;i.prototype.applyForce=function(n,t){var r,u;this.type===i.DYNAMIC&&(r=l,t.vsub(this.position,r),u=a,r.cross(n,u),this.force.vadd(n,this.force),this.torque.vadd(u,this.torque))};v=new r;y=new r;i.prototype.applyLocalForce=function(n,t){if(this.type===i.DYNAMIC){var r=v,u=y;this.vectorToWorldFrame(n,r);this.pointToWorldFrame(t,u);this.applyForce(r,u)}};var tt=new r,it=new r,rt=new r;i.prototype.applyImpulse=function(n,t){var f,r,u;this.type===i.DYNAMIC&&(f=tt,t.vsub(this.position,f),r=it,r.copy(n),r.mult(this.invMass,r),this.velocity.vadd(r,this.velocity),u=rt,f.cross(n,u),this.invInertiaWorld.vmult(u,u),this.angularVelocity.vadd(u,this.angularVelocity))};p=new r;w=new r;i.prototype.applyLocalImpulse=function(n,t){if(this.type===i.DYNAMIC){var r=p,u=w;this.vectorToWorldFrame(n,r);this.pointToWorldFrame(t,u);this.applyImpulse(r,u)}};b=new r;i.prototype.updateMassProperties=function(){var i=b,n,t;this.invMass=this.mass>0?1/this.mass:0;n=this.inertia;t=this.fixedRotation;this.computeAABB();i.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2);k.calculateInertia(i,this.mass,n);this.invInertia.set(n.x>0&&!t?1/n.x:0,n.y>0&&!t?1/n.y:0,n.z>0&&!t?1/n.z:0);this.updateInertiaWorld(!0)};i.prototype.getVelocityAtWorldPoint=function(n,t){var i=new r;return n.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(n,t){function r(n){this.chassisBody=n.chassisBody;this.wheelInfos=[];this.sliding=!1;this.world=null;this.indexRightAxis=typeof n.indexRightAxis!="undefined"?n.indexRightAxis:1;this.indexForwardAxis=typeof n.indexForwardAxis!="undefined"?n.indexForwardAxis:0;this.indexUpAxis=typeof n.indexUpAxis!="undefined"?n.indexUpAxis:2}function tt(n,t,i,r,u){var f=0,e=i,o=d,h=g,c=nt;n.getVelocityAtWorldPoint(e,o);t.getVelocityAtWorldPoint(e,h);o.vsub(h,c);var l=r.dot(c),a=s(n,i,r),v=s(t,i,r),y=1/(a+v);return f=-l*y,u<f&&(f=u),f<-u&&(f=-u),f}function s(n,t,i){var r=it,u=rt,f=ut,e=ft;return t.vsub(n.position,r),r.cross(i,u),n.invInertiaWorld.vmult(u,e),e.cross(r,f),n.invMass+i.dot(f)}function ht(n,t,i,r,u){var s=u.norm2();if(s>1.1)return 0;var f=et,e=ot,o=st;n.getVelocityAtWorldPoint(t,f);i.getVelocityAtWorldPoint(r,e);f.vsub(e,o);var h=u.dot(o),c=1/(n.invMass+i.invMass);return-.2*h*c}var ct=n("./Body"),i=n("../math/Vec3"),u=n("../math/Quaternion"),lt=n("../collision/RaycastResult"),h=n("../collision/Ray"),c=n("../objects/WheelInfo"),y,f,e,o;t.exports=r;var at=new i,vt=new i,yt=new i,l=new i,a=new i,v=new i,pt=new h;r.prototype.addWheel=function(n){n=n||{};var t=new c(n),i=this.wheelInfos.length;return this.wheelInfos.push(t),i};r.prototype.setSteeringValue=function(n,t){var i=this.wheelInfos[t];i.steering=n};y=new i;r.prototype.applyEngineForce=function(n,t){this.wheelInfos[t].engineForce=n};r.prototype.setBrake=function(n,t){this.wheelInfos[t].brake=n};r.prototype.addToWorld=function(n){var i=this.constraints,t;n.add(this.chassisBody);t=this;this.preStepCallback=function(){t.updateVehicle(n.dt)};n.addEventListener("preStep",this.preStepCallback);this.world=n};r.prototype.getVehicleAxisWorld=function(n,t){t.set(n===0?1:0,n===1?1:0,n===2?1:0);this.chassisBody.vectorToWorldFrame(t,t)};r.prototype.updateVehicle=function(n){for(var h,c,a,s,t,l,p,w,e=this.wheelInfos,o=e.length,u=this.chassisBody,r=0;r<o;r++)this.updateWheelTransform(r);for(this.currentVehicleSpeedKmHour=3.6*u.velocity.norm(),h=new i,this.getVehicleAxisWorld(this.indexForwardAxis,h),h.dot(u.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<o;r++)this.castRay(e[r]);for(this.updateSuspension(n),c=new i,a=new i,r=0;r<o;r++)t=e[r],s=t.suspensionForce,s>t.maxSuspensionForce&&(s=t.maxSuspensionForce),t.raycastResult.hitNormalWorld.scale(s*n,c),t.raycastResult.hitPointWorld.vsub(u.position,a),u.applyImpulse(c,t.raycastResult.hitPointWorld);this.updateFriction(n);var v=new i,f=new i,y=new i;for(r=0;r<o;r++){t=e[r];u.getVelocityAtWorldPoint(t.chassisConnectionPointWorld,y);l=1;switch(this.indexUpAxis){case 1:l=-1}t.isInContact&&(this.getVehicleAxisWorld(this.indexForwardAxis,f),p=f.dot(t.raycastResult.hitNormalWorld),t.raycastResult.hitNormalWorld.scale(p,v),f.vsub(v,f),w=f.dot(y),t.deltaRotation=l*w*n/t.radius);(t.sliding||!t.isInContact)&&t.engineForce!==0&&t.useCustomSlidingRotationalSpeed&&(t.deltaRotation=(t.engineForce>0?1:-1)*t.customSlidingRotationalSpeed*n);Math.abs(t.brake)>Math.abs(t.engineForce)&&(t.deltaRotation=0);t.rotation+=t.deltaRotation;t.deltaRotation*=.99}};r.prototype.updateSuspension=function(){for(var n,r,f,e=this.chassisBody,o=e.mass,u=this.wheelInfos,s=u.length,t=0;t<s;t++)if(n=u[t],n.isInContact){var i,h=n.suspensionRestLength,c=n.suspensionLength,l=h-c;i=n.suspensionStiffness*l*n.clippedInvContactDotSuspension;r=n.suspensionRelativeVelocity;f=r<0?n.dampingCompression:n.dampingRelaxation;i-=f*r;n.suspensionForce=i*o;n.suspensionForce<0&&(n.suspensionForce=0)}else n.suspensionForce=0};r.prototype.removeFromWorld=function(n){var t=this.constraints;n.remove(this.chassisBody);n.removeEventListener("preStep",this.preStepCallback);this.world=null};f=new i;e=new i;r.prototype.castRay=function(n){var a=f,v=e,u,t,g,p,w,b,o,s,h,c,k,l;this.updateWheelTransformWorld(n);var r=this.chassisBody,y=-1,d=n.suspensionRestLength+n.radius;return n.directionWorld.scale(d,a),u=n.chassisConnectionPointWorld,u.vadd(a,v),t=n.raycastResult,g=0,t.reset(),p=r.collisionResponse,r.collisionResponse=!1,this.world.rayTest(u,v,t),r.collisionResponse=p,w=t.body,n.raycastResult.groundObject=0,w?(y=t.distance,n.raycastResult.hitNormalWorld=t.hitNormalWorld,n.isInContact=!0,b=t.distance,n.suspensionLength=b-n.radius,o=n.suspensionRestLength-n.maxSuspensionTravel,s=n.suspensionRestLength+n.maxSuspensionTravel,n.suspensionLength<o&&(n.suspensionLength=o),n.suspensionLength>s&&(n.suspensionLength=s,n.raycastResult.reset()),h=n.raycastResult.hitNormalWorld.dot(n.directionWorld),c=new i,r.getVelocityAtWorldPoint(n.raycastResult.hitPointWorld,c),k=n.raycastResult.hitNormalWorld.dot(c),h>=-.1?(n.suspensionRelativeVelocity=0,n.clippedInvContactDotSuspension=1/.1):(l=-1/h,n.suspensionRelativeVelocity=k*l,n.clippedInvContactDotSuspension=l)):(n.suspensionLength=n.suspensionRestLength+0*n.maxSuspensionTravel,n.suspensionRelativeVelocity=0,n.directionWorld.scale(-1,n.raycastResult.hitNormalWorld),n.clippedInvContactDotSuspension=1),y};r.prototype.updateWheelTransformWorld=function(n){n.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(n.chassisConnectionPointLocal,n.chassisConnectionPointWorld);t.vectorToWorldFrame(n.directionLocal,n.directionWorld);t.vectorToWorldFrame(n.axleLocal,n.axleWorld)};r.prototype.updateWheelTransform=function(n){var e=l,f=a,h=v,t=this.wheelInfos[n],c,o,s,r,i;this.updateWheelTransformWorld(t);t.directionLocal.scale(-1,e);f.copy(t.axleLocal);e.cross(f,h);h.normalize();f.normalize();c=t.steering;o=new u;o.setFromAxisAngle(e,c);s=new u;s.setFromAxisAngle(f,t.rotation);r=t.worldTransform.quaternion;this.chassisBody.quaternion.mult(o,r);r.mult(s,r);r.normalize();i=t.worldTransform.position;i.copy(t.directionWorld);i.scale(t.suspensionLength,i);i.vadd(t.chassisConnectionPointWorld,i)};o=[new i(1,0,0),new i(0,1,0),new i(0,0,1)];r.prototype.getWheelTransformWorld=function(n){return this.wheelInfos[n].worldTransform};var p=new i,w=[],b=[],k=1;r.prototype.updateFriction=function(n){for(var e,et,y,ot,st,ct,lt,nt,g,t,f,rt,u,ut,l,ft=p,s=this.wheelInfos,a=s.length,h=this.chassisBody,c=b,v=w,pt=0,r=0;r<a;r++)t=s[r],u=t.raycastResult.body,u&&pt++,t.sideImpulse=0,t.forwardImpulse=0,c[r]||(c[r]=new i),v[r]||(v[r]=new i);for(r=0;r<a;r++)t=s[r],u=t.raycastResult.body,u&&(e=v[r],et=this.getWheelTransformWorld(r),et.vectorToWorldFrame(o[this.indexRightAxis],e),y=t.raycastResult.hitNormalWorld,ot=e.dot(y),y.scale(ot,ft),e.vsub(ft,e),e.normalize(),y.cross(e,c[r]),c[r].normalize(),t.sideImpulse=ht(h,t.raycastResult.hitPointWorld,u,t.raycastResult.hitPointWorld,e),t.sideImpulse*=k);for(st=1,ct=.5,this.sliding=!1,r=0;r<a;r++){var t=s[r],u=t.raycastResult.body,d=0;if(t.slipInfo=1,u&&(lt=0,nt=t.brake?t.brake:lt,d=tt(h,u,t.raycastResult.hitPointWorld,c[r],nt),d+=t.engineForce*n,g=nt/d,t.slipInfo*=g),t.forwardImpulse=0,t.skidInfo=1,u){t.skidInfo=1;var it=t.suspensionForce*n*t.frictionSlip,wt=it,bt=it*wt;t.forwardImpulse=d;var at=t.forwardImpulse*ct,vt=t.sideImpulse*st,yt=at*at+vt*vt;t.sliding=!1;yt>bt&&(this.sliding=!0,t.sliding=!0,g=it/Math.sqrt(yt),t.skidInfo*=g)}}if(this.sliding)for(r=0;r<a;r++)t=s[r],t.sideImpulse!==0&&t.skidInfo<1&&(t.forwardImpulse*=t.skidInfo,t.sideImpulse*=t.skidInfo);for(r=0;r<a;r++)t=s[r],f=new i,f.copy(t.raycastResult.hitPointWorld),t.forwardImpulse!==0&&(rt=new i,c[r].scale(t.forwardImpulse,rt),h.applyImpulse(rt,f)),t.sideImpulse!==0&&(u=t.raycastResult.body,ut=new i,ut.copy(t.raycastResult.hitPointWorld),l=new i,v[r].scale(t.sideImpulse,l),h.pointToLocalFrame(f,f),f["xyz"[this.indexUpAxis]]*=t.rollInfluence,h.pointToWorldFrame(f,f),h.applyImpulse(l,f),l.scale(-1,l),u.applyImpulse(l,ut))};var d=new i,g=new i,nt=new i;var it=new i,rt=new i,ut=new i,ft=new i;var et=new i,ot=new i,st=new i},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(n,t){function i(n){if(this.wheelBodies=[],this.coordinateSystem=typeof n.coordinateSystem=="undefined"?new r(1,2,3):n.coordinateSystem.clone(),this.chassisBody=n.chassisBody,!this.chassisBody){var t=new s(new r(5,2,.5));this.chassisBody=new e(1,t)}this.constraints=[];this.wheelAxes=[];this.wheelForces=[]}var e=n("./Body"),o=n("../shapes/Sphere"),s=n("../shapes/Box"),r=n("../math/Vec3"),h=n("../constraints/HingeConstraint"),u,f;t.exports=i;i.prototype.addWheel=function(n){var t,u,s;n=n||{};t=n.body;t||(t=new e(1,new o(1.2)));this.wheelBodies.push(t);this.wheelForces.push(0);var c=new r,f=typeof n.position!="undefined"?n.position.clone():new r,i=new r;return this.chassisBody.pointToWorldFrame(f,i),t.position.set(i.x,i.y,i.z),u=typeof n.axis!="undefined"?n.axis.clone():new r(0,1,0),this.wheelAxes.push(u),s=new h(this.chassisBody,t,{pivotA:f,axisA:u,pivotB:r.ZERO,axisB:u,collideConnected:!1}),this.constraints.push(s),this.wheelBodies.length-1};i.prototype.setSteeringValue=function(n,t){var i=this.wheelAxes[t],r=Math.cos(n),u=Math.sin(n),f=i.x,e=i.y;this.constraints[t].axisA.set(r*f-u*e,u*f+r*e,0)};i.prototype.setMotorSpeed=function(n,t){var i=this.constraints[t];i.enableMotor();i.motorTargetVelocity=n};i.prototype.disableMotor=function(n){var t=this.constraints[n];t.disableMotor()};u=new r;i.prototype.setWheelForce=function(n,t){this.wheelForces[t]=n};i.prototype.applyWheelForce=function(n,t){var f=this.wheelAxes[t],i=this.wheelBodies[t],r=i.torque;f.scale(n,u);i.vectorToWorldFrame(u,u);r.vadd(u,r)};i.prototype.addToWorld=function(n){for(var i=this.constraints,r=this.wheelBodies.concat([this.chassisBody]),t=0;t<r.length;t++)n.add(r[t]);for(t=0;t<i.length;t++)n.addConstraint(i[t]);n.addEventListener("preStep",this._update.bind(this))};i.prototype._update=function(){for(var t=this.wheelForces,n=0;n<t.length;n++)this.applyWheelForce(t[n],n)};i.prototype.removeFromWorld=function(n){for(var i=this.constraints,r=this.wheelBodies.concat([this.chassisBody]),t=0;t<r.length;t++)n.remove(r[t]);for(t=0;t<i.length;t++)n.removeConstraint(i[t])};f=new r;i.prototype.getWheelSpeed=function(n){var t=this.wheelAxes[n],i=this.wheelBodies[n],r=i.angularVelocity;return this.chassisBody.vectorToWorldFrame(t,f),r.dot(f)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(n,t){function i(){this.particles=[];this.density=1;this.smoothingRadius=1;this.speedOfSound=1;this.viscosity=.01;this.eps=1e-6;this.pressures=[];this.densities=[];this.neighbors=[]}var u;t.exports=i;var l=n("../shapes/Shape"),r=n("../math/Vec3"),a=n("../math/Quaternion"),v=n("../shapes/Particle"),y=n("../objects/Body"),p=n("../material/Material");i.prototype.add=function(n){this.particles.push(n);this.neighbors.length<this.particles.length&&this.neighbors.push([])};i.prototype.remove=function(n){var t=this.particles.indexOf(n);t!==-1&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};u=new r;i.prototype.getNeighbors=function(n,t){for(var i,e=this.particles.length,o=n.id,s=this.smoothingRadius*this.smoothingRadius,f=u,r=0;r!==e;r++)i=this.particles[r],i.position.vsub(n.position,f),o!==i.id&&f.norm2()<s&&t.push(i)};var f=new r,e=new r,o=new r,s=new r,h=new r,c=new r;i.prototype.update=function(){for(var w,b,it,rt,r,ut,ft,i,y,t,v,et,d=this.particles.length,g=f,nt=this.speedOfSound,tt=this.eps,n=0;n!==d;n++){for(w=this.particles[n],i=this.neighbors[n],i.length=0,this.getNeighbors(w,i),i.push(this.particles[n]),y=i.length,b=0,t=0;t!==y;t++)w.position.vsub(i[t].position,g),it=g.norm(),rt=this.w(it),b+=i[t].mass*rt;this.densities[n]=b;this.pressures[n]=nt*nt*(this.densities[n]-this.density)}var u=e,l=o,p=s,k=h,a=c;for(n=0;n!==d;n++){for(r=this.particles[n],u.set(0,0,0),l.set(0,0,0),i=this.neighbors[n],y=i.length,t=0;t!==y;t++)v=i[t],r.position.vsub(v.position,k),et=k.norm(),ut=-v.mass*(this.pressures[n]/(this.densities[n]*this.densities[n]+tt)+this.pressures[t]/(this.densities[t]*this.densities[t]+tt)),this.gradw(k,p),p.mult(ut,p),u.vadd(p,u),v.velocity.vsub(r.velocity,a),a.mult(1/(.0001+this.densities[n]*this.densities[t])*this.viscosity*v.mass,a),ft=this.nablaw(et),a.mult(ft,a),l.vadd(a,l);l.mult(r.mass,l);u.mult(r.mass,u);r.force.vadd(l,r.force);r.force.vadd(u,r.force)}};i.prototype.w=function(n){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-n*n,3)};i.prototype.gradw=function(n,t){var r=n.norm(),i=this.smoothingRadius;n.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-r*r,2),t)};i.prototype.nablaw=function(n){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-n*n)*(7*n*n-3*t*t)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(n,t){function r(n,t,r){r=r||{};this.restLength=typeof r.restLength=="number"?r.restLength:1;this.stiffness=r.stiffness||100;this.damping=r.damping||1;this.bodyA=n;this.bodyB=t;this.localAnchorA=new i;this.localAnchorB=new i;r.localAnchorA&&this.localAnchorA.copy(r.localAnchorA);r.localAnchorB&&this.localAnchorB.copy(r.localAnchorB);r.worldAnchorA&&this.setWorldAnchorA(r.worldAnchorA);r.worldAnchorB&&this.setWorldAnchorB(r.worldAnchorB)}var i=n("../math/Vec3");t.exports=r;r.prototype.setWorldAnchorA=function(n){this.bodyA.pointToLocalFrame(n,this.localAnchorA)};r.prototype.setWorldAnchorB=function(n){this.bodyB.pointToLocalFrame(n,this.localAnchorB)};r.prototype.getWorldAnchorA=function(n){this.bodyA.pointToWorldFrame(this.localAnchorA,n)};r.prototype.getWorldAnchorB=function(n){this.bodyB.pointToWorldFrame(this.localAnchorB,n)};var u=new i,f=new i,e=new i,o=new i,s=new i,h=new i,c=new i,l=new i,a=new i,v=new i,y=new i;r.prototype.applyForce=function(){var ut=this.stiffness,ft=this.damping,et=this.restLength,n=this.bodyA,t=this.bodyB,b=u,p=f,i=e,r=o,w=y,k=s,d=h,g=c,nt=l,tt=a,it=v,rt;this.getWorldAnchorA(k);this.getWorldAnchorB(d);k.vsub(n.position,g);d.vsub(t.position,nt);d.vsub(k,b);rt=b.norm();p.copy(b);p.normalize();t.velocity.vsub(n.velocity,i);t.angularVelocity.cross(nt,w);i.vadd(w,i);n.angularVelocity.cross(g,w);i.vsub(w,i);p.mult(-ut*(rt-et)-ft*i.dot(p),r);n.force.vsub(r,n.force);t.force.vadd(r,t.force);g.cross(r,tt);nt.cross(r,it);n.torque.vsub(tt,n.torque);t.torque.vadd(it,t.torque)}},{"../math/Vec3":30}],36:[function(n,t){function r(n){n=s.defaults(n,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,axleWorld:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1});this.maxSuspensionTravel=n.maxSuspensionTravel;this.customSlidingRotationalSpeed=n.customSlidingRotationalSpeed;this.useCustomSlidingRotationalSpeed=n.useCustomSlidingRotationalSpeed;this.sliding=!1;this.chassisConnectionPointLocal=n.chassisConnectionPointLocal.clone();this.chassisConnectionPointWorld=n.chassisConnectionPointWorld.clone();this.directionLocal=n.directionLocal.clone();this.directionWorld=n.directionWorld.clone();this.axleLocal=n.axleLocal.clone();this.axleWorld=n.axleWorld.clone();this.suspensionRestLength=n.suspensionRestLength;this.suspensionMaxLength=n.suspensionMaxLength;this.radius=n.radius;this.suspensionStiffness=n.suspensionStiffness;this.dampingCompression=n.dampingCompression;this.dampingRelaxation=n.dampingRelaxation;this.frictionSlip=n.frictionSlip;this.steering=0;this.rotation=0;this.deltaRotation=0;this.rollInfluence=n.rollInfluence;this.maxSuspensionForce=n.maxSuspensionForce;this.engineForce=0;this.brake=0;this.isFrontWheel=n.isFrontWheel;this.clippedInvContactDotSuspension=1;this.suspensionRelativeVelocity=0;this.suspensionForce=0;this.skidInfo=0;this.suspensionLength=0;this.sideImpulse=0;this.forwardImpulse=0;this.raycastResult=new o;this.worldTransform=new e;this.isInContact=!1}var i=n("../math/Vec3"),e=n("../math/Transform"),o=n("../collision/RaycastResult"),s=n("../utils/Utils");t.exports=r;var u=new i,f=new i,u=new i;r.prototype.updateWheel=function(n){var t=this.raycastResult,i,e,r;this.isInContact?(i=t.hitNormalWorld.dot(t.directionWorld),t.hitPointWorld.vsub(n.position,f),n.getVelocityAtWorldPoint(f,u),e=t.hitNormalWorld.dot(u),i>=-.1?(this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1):(r=-1/i,this.suspensionRelativeVelocity=e*r,this.clippedInvContactDotSuspension=r)):(t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1)}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(n,t){function i(n){e.call(this);this.type=e.types.BOX;this.halfExtents=n;this.convexPolyhedronRepresentation=null;this.updateConvexPolyhedronRepresentation();this.updateBoundingSphereRadius()}var f,s,u;t.exports=i;var e=n("./Shape"),r=n("../math/Vec3"),o=n("./ConvexPolyhedron");i.prototype=new e;i.prototype.constructor=i;i.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,u=this.halfExtents.z,n=r,e=[new n(-t,-i,-u),new n(t,-i,-u),new n(t,i,-u),new n(-t,i,-u),new n(-t,-i,u),new n(t,-i,u),new n(t,i,u),new n(-t,i,u)],s=[new n(0,0,1),new n(0,1,0),new n(1,0,0)],f=new o(e,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5],]);this.convexPolyhedronRepresentation=f;f.material=this.material};i.prototype.calculateLocalInertia=function(n,t){return t=t||new r,i.calculateInertia(this.halfExtents,n,t),t};i.calculateInertia=function(n,t,i){var r=n;i.x=1/12*t*(4*r.y*r.y+4*r.z*r.z);i.y=1/12*t*(4*r.x*r.x+4*r.z*r.z);i.z=1/12*t*(4*r.y*r.y+4*r.x*r.x)};i.prototype.getSideNormals=function(n,t){var i=n,r=this.halfExtents,u;if(i[0].set(r.x,0,0),i[1].set(0,r.y,0),i[2].set(0,0,r.z),i[3].set(-r.x,0,0),i[4].set(0,-r.y,0),i[5].set(0,0,-r.z),t!==undefined)for(u=0;u!==i.length;u++)t.vmult(i[u],i[u]);return i};i.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z};i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};f=new r;s=new r;i.prototype.forEachWorldCorner=function(n,t,i){for(var r=this.halfExtents,e=[[r.x,r.y,r.z],[-r.x,r.y,r.z],[-r.x,-r.y,r.z],[-r.x,-r.y,-r.z],[r.x,-r.y,-r.z],[r.x,r.y,-r.z],[-r.x,r.y,-r.z],[r.x,-r.y,r.z]],u=0;u<e.length;u++)f.set(e[u][0],e[u][1],e[u][2]),t.vmult(f,f),n.vadd(f,f),i(f.x,f.y,f.z)};u=[new r,new r,new r,new r,new r,new r,new r,new r];i.prototype.calculateWorldAABB=function(n,t,i,r){var f=this.halfExtents,o,e;for(u[0].set(f.x,f.y,f.z),u[1].set(-f.x,f.y,f.z),u[2].set(-f.x,-f.y,f.z),u[3].set(-f.x,-f.y,-f.z),u[4].set(f.x,-f.y,-f.z),u[5].set(f.x,f.y,-f.z),u[6].set(-f.x,f.y,-f.z),u[7].set(f.x,-f.y,f.z),e=u[0],t.vmult(e,e),n.vadd(e,e),r.copy(e),i.copy(e),o=1;o<8;o++){e=u[o];t.vmult(e,e);n.vadd(e,e);var s=e.x,h=e.y,c=e.z;s>r.x&&(r.x=s);h>r.y&&(r.y=h);c>r.z&&(r.z=c);s<i.x&&(i.x=s);h<i.y&&(i.y=h);c<i.z&&(i.z=c)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(n,t){function r(n,t,i){var r=this;h.call(this);this.type=h.types.CONVEXPOLYHEDRON;this.vertices=n||[];this.worldVertices=[];this.worldVerticesNeedsUpdate=!0;this.faces=t||[];this.faceNormals=[];this.computeNormals();this.worldFaceNormalsNeedsUpdate=!0;this.worldFaceNormals=[];this.uniqueEdges=[];this.uniqueAxes=i?i.slice():null;this.computeEdges();this.updateBoundingSphereRadius()}var v,c,l,y,o,s,f,e,p,u;t.exports=r;var h=n("./Shape"),i=n("../math/Vec3"),pt=n("../math/Quaternion"),a=n("../math/Transform");r.prototype=new h;r.prototype.constructor=r;v=new i;r.prototype.computeEdges=function(){var h=this.faces,e=this.vertices,l=e.length,t=this.uniqueEdges,n,u,f,o,i,c,s,r;for(t.length=0,n=v,u=0;u!==h.length;u++)for(f=h[u],o=f.length,i=0;i!==o;i++){for(c=(i+1)%o,e[f[i]].vsub(e[f[c]],n),n.normalize(),s=!1,r=0;r!==t.length;r++)if(t[r].almostEquals(n)||t[r].almostEquals(n)){s=!0;break}s||t.push(n.clone())}};r.prototype.computeNormals=function(){var n,r,u,t;for(this.faceNormals.length=this.faces.length,n=0;n<this.faces.length;n++){for(t=0;t<this.faces[n].length;t++)if(!this.vertices[this.faces[n][t]])throw new Error("Vertex "+this.faces[n][t]+" not found!");if(r=this.faceNormals[n]||new i,this.getFaceNormal(n,r),r.negate(r),this.faceNormals[n]=r,u=this.vertices[this.faces[n][0]],r.dot(u)<0)for(console.error(".faceNormals["+n+"] = Vec3("+r.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[n].length;t++)console.warn(".vertices["+this.faces[n][t]+"] = Vec3("+this.vertices[this.faces[n][t]].toString()+")")}};c=new i;l=new i;r.computeNormal=function(n,t,i,r){t.vsub(n,l);i.vsub(t,c);c.cross(l,r);r.isZero()||r.normalize()};r.prototype.getFaceNormal=function(n,t){var i=this.faces[n],u=this.vertices[i[0]],f=this.vertices[i[1]],e=this.vertices[i[2]];return r.computeNormal(u,f,e,t)};y=new i;r.prototype.clipAgainstHull=function(n,t,r,u,f,e,o,s,h){for(var w,v,g,c,l=y,tt=this,it=s,p=-1,b=-Number.MAX_VALUE,a=0;a<r.faces.length;a++)l.copy(r.faceNormals[a]),f.vmult(l,l),w=l.dot(e),w>b&&(b=w,p=a);var k=[],d=r.faces[p],nt=d.length;for(v=0;v<nt;v++)g=r.vertices[d[v]],c=new i,c.copy(g),f.vmult(c,c),u.vadd(c,c),k.push(c);p>=0&&this.clipFaceAgainstHull(e,n,t,k,o,s,h)};var w=new i,b=new i,k=new i,d=new i,g=new i,nt=new i;r.prototype.findSeparatingAxis=function(n,t,i,r,u,f,e,o){var a=w,v=b,ut=k,ft=d,et=g,y=nt,l=Number.MAX_VALUE,c=this,ot=0,st,ht,p,s,h,tt,it,rt;if(c.uniqueAxes)for(s=0;s!==c.uniqueAxes.length;s++){if(i.vmult(c.uniqueAxes[s],a),h=c.testSepAxis(a,n,t,i,r,u),h===!1)return!1;h<l&&(l=h,f.copy(a))}else for(st=e?e.length:c.faces.length,s=0;s<st;s++){if(p=e?e[s]:s,a.copy(c.faceNormals[p]),i.vmult(a,a),h=c.testSepAxis(a,n,t,i,r,u),h===!1)return!1;h<l&&(l=h,f.copy(a))}if(n.uniqueAxes)for(s=0;s!==n.uniqueAxes.length;s++){if(u.vmult(n.uniqueAxes[s],v),ot++,h=c.testSepAxis(v,n,t,i,r,u),h===!1)return!1;h<l&&(l=h,f.copy(v))}else for(ht=o?o.length:n.faces.length,s=0;s<ht;s++){if(p=o?o[s]:s,v.copy(n.faceNormals[p]),u.vmult(v,v),ot++,h=c.testSepAxis(v,n,t,i,r,u),h===!1)return!1;h<l&&(l=h,f.copy(v))}for(tt=0;tt!==c.uniqueEdges.length;tt++)for(i.vmult(c.uniqueEdges[tt],ft),it=0;it!==n.uniqueEdges.length;it++)if(u.vmult(n.uniqueEdges[it],et),ft.cross(et,y),!y.almostZero()){if(y.normalize(),rt=c.testSepAxis(y,n,t,i,r,u),rt===!1)return!1;rt<l&&(l=rt,f.copy(y))}return r.vsub(t,ut),ut.dot(f)>0&&f.negate(f),!0};o=[];s=[];r.prototype.testSepAxis=function(n,t,i,u,f,e){var p=this;r.project(p,n,i,u,o);r.project(t,n,f,e,s);var h=o[0],c=o[1],l=s[0],a=s[1];if(h<a||l<c)return!1;var v=h-a,y=l-c;return v<y?v:y};f=new i;e=new i;r.prototype.calculateLocalInertia=function(n,t){this.computeLocalAABB(f,e);var i=e.x-f.x,r=e.y-f.y,u=e.z-f.z;t.x=1/12*n*(4*r*r+4*u*u);t.y=1/12*n*(4*i*i+4*u*u);t.z=1/12*n*(4*r*r+4*i*i)};r.prototype.getPlaneConstantOfFace=function(n){var t=this.faces[n],i=this.faceNormals[n],r=this.vertices[t[0]];return-i.dot(r)};var tt=new i,it=new i,rt=new i,ut=new i,ft=new i,et=new i,ot=new i,st=new i;r.prototype.clipFaceAgainstHull=function(n,t,i,r,u,f,e){for(var vt,h,ct,b,yt,dt,gt,pt,lt,d,o,v,ni,ti,g=tt,wt=it,y=rt,p=ut,k=ft,w=et,nt=ot,s=st,c=this,l=r,at=[],a=-1,bt=Number.MAX_VALUE,ht=0;ht<c.faces.length;ht++)g.copy(c.faceNormals[ht]),i.vmult(g,g),vt=g.dot(n),vt<bt&&(bt=vt,a=ht);if(!(a<0)){for(h=c.faces[a],h.connectedFaces=[],o=0;o<c.faces.length;o++)for(ct=0;ct<c.faces[o].length;ct++)h.indexOf(c.faces[o][ct])!==-1&&o!==a&&h.connectedFaces.indexOf(o)===-1&&h.connectedFaces.push(o);var ii=l.length,kt=h.length;for(b=0;b<kt;b++){for(yt=c.vertices[h[b]],dt=c.vertices[h[(b+1)%kt]],yt.vsub(dt,wt),y.copy(wt),i.vmult(y,y),t.vadd(y,y),p.copy(this.faceNormals[a]),i.vmult(p,p),t.vadd(p,p),y.cross(p,k),k.negate(k),w.copy(yt),i.vmult(w,w),t.vadd(w,w),gt=-w.dot(k),pt=h.connectedFaces[b],nt.copy(this.faceNormals[pt]),lt=this.getPlaneConstantOfFace(pt),s.copy(nt),i.vmult(s,s),d=lt-s.dot(t),this.clipFaceAgainstPlane(l,at,s,d);l.length;)l.shift();while(at.length)l.push(at.shift())}for(nt.copy(this.faceNormals[a]),lt=this.getPlaneConstantOfFace(a),s.copy(nt),i.vmult(s,s),d=lt-s.dot(t),o=0;o<l.length;o++)v=s.dot(l[o])+d,v<=u&&(console.log("clamped: depth="+v+" to minDist="+(u+"")),v=u),v<=f&&(ni=l[o],v<=0&&(ti={point:ni,normal:s,depth:v},e.push(ti)))}};r.prototype.clipFaceAgainstPlane=function(n,t,r,u){var o,s,l=n.length,h,e,c,f;if(l<2)return t;for(h=n[n.length-1],e=n[0],o=r.dot(h)+u,c=0;c<l;c++)e=n[c],s=r.dot(e)+u,o<0?s<0?(f=new i,f.copy(e),t.push(f)):(f=new i,h.lerp(e,o/(o-s),f),t.push(f)):s<0&&(f=new i,h.lerp(e,o/(o-s),f),t.push(f),t.push(e)),h=e,o=s;return t};r.prototype.computeWorldVertices=function(n,t){for(var f=this.vertices.length,e,u,r;this.worldVertices.length<f;)this.worldVertices.push(new i);for(e=this.vertices,u=this.worldVertices,r=0;r!==f;r++)t.vmult(e[r],u[r]),n.vadd(u[r],u[r]);this.worldVerticesNeedsUpdate=!1};p=new i;r.prototype.computeLocalAABB=function(n,t){var u=this.vertices.length,f=this.vertices,e=p,r,i;for(n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r=0;r<u;r++)i=f[r],i.x<n.x?n.x=i.x:i.x>t.x&&(t.x=i.x),i.y<n.y?n.y=i.y:i.y>t.y&&(t.y=i.y),i.z<n.z?n.z=i.z:i.z>t.z&&(t.z=i.z)};r.prototype.computeWorldFaceNormals=function(n){for(var r=this.faceNormals.length,u,f,t;this.worldFaceNormals.length<r;)this.worldFaceNormals.push(new i);for(u=this.faceNormals,f=this.worldFaceNormals,t=0;t!==r;t++)n.vmult(u[t],f[t]);this.worldFaceNormalsNeedsUpdate=!1};r.prototype.updateBoundingSphereRadius=function(){for(var i,n=0,r=this.vertices,t=0,u=r.length;t!==u;t++)i=r[t].norm2(),i>n&&(n=i);this.boundingSphereRadius=Math.sqrt(n)};u=new i;r.prototype.calculateWorldAABB=function(n,t,i,r){for(var f,v=this.vertices.length,y=this.vertices,e,o,s,h,c,l,a=0;a<v;a++)u.copy(y[a]),t.vmult(u,u),n.vadd(u,u),f=u,f.x<e||e===undefined?e=f.x:(f.x>h||h===undefined)&&(h=f.x),f.y<o||o===undefined?o=f.y:(f.y>c||c===undefined)&&(c=f.y),f.z<s||s===undefined?s=f.z:(f.z>l||l===undefined)&&(l=f.z);i.set(e,o,s);r.set(h,c,l)};r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};r.prototype.getAveragePointLocal=function(n){var r,u,t;for(n=n||new i,r=this.vertices.length,u=this.vertices,t=0;t<r;t++)n.vadd(u[t],n);return n.mult(1/r,n),n};r.prototype.transformAllPoints=function(n,t){var u=this.vertices.length,f=this.vertices,i,r;if(t){for(i=0;i<u;i++)r=f[i],t.vmult(r,r);for(i=0;i<this.faceNormals.length;i++)r=this.faceNormals[i],t.vmult(r,r)}if(n)for(i=0;i<u;i++)r=f[i],r.vadd(n,r)};var ht=new i,ct=new i,lt=new i;r.prototype.pointIsInside=function(n){var f=this.vertices.length,h=this.vertices,c=this.faces,l=this.faceNormals,a=this.faces.length,e=ht,t,i,r,u;for(this.getAveragePointLocal(e),t=0;t<a;t++){var v=this.faces[t].length,f=l[t],o=h[c[t][0]],s=ct;if(n.vsub(o,s),i=f.dot(s),r=lt,e.vsub(o,r),u=f.dot(r),i<0&&u>0||i>0&&u<0)return!1}return-1};var at=new i,vt=new i,yt=new i;r.project=function(n,t,i,r,u){var p=n.vertices.length,w=at,s=vt,f=0,e=0,h=yt,v=n.vertices,l,c,o,y;for(h.setZero(),a.vectorToLocalFrame(i,r,t,s),a.pointToLocalFrame(i,r,h,h),l=h.dot(s),e=f=v[0].dot(s),c=1;c<p;c++)o=v[c].dot(s),o>f&&(f=o),o<e&&(e=o);e-=l;f-=l;e>f&&(y=e,e=f,f=y);u[0]=f;u[1]=e}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(n,t){function u(n,t,u,e){var s=e,h=[],p=[],c=[],l=[],w=[],a=Math.cos,v=Math.sin,y,b,k,o;for(h.push(new i(t*a(0),t*v(0),-u*.5)),l.push(0),h.push(new i(n*a(0),n*v(0),u*.5)),w.push(1),o=0;o<s;o++)y=2*Math.PI/s*(o+1),b=2*Math.PI/s*(o+.5),o<s-1?(h.push(new i(t*a(y),t*v(y),-u*.5)),l.push(2*o+2),h.push(new i(n*a(y),n*v(y),u*.5)),w.push(2*o+3),c.push([2*o+2,2*o+3,2*o+1,2*o])):c.push([0,1,2*o+1,2*o]),(s%2==1||o<s/2)&&p.push(new i(a(b),v(b),0));for(c.push(w),p.push(new i(0,0,1)),k=[],o=0;o<l.length;o++)k.push(l[l.length-o-1]);c.push(k);this.type=f.types.CONVEXPOLYHEDRON;r.call(this,h,c,p)}t.exports=u;var f=n("./Shape"),i=n("../math/Vec3"),e=n("../math/Quaternion"),r=n("./ConvexPolyhedron");u.prototype=new r},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(n,t){function i(n,t){t=e.defaults(t,{maxValue:null,minValue:null,elementSize:1});this.data=n;this.maxValue=t.maxValue;this.minValue=t.minValue;this.elementSize=t.elementSize;t.minValue===null&&this.updateMinValue();t.maxValue===null&&this.updateMaxValue();this.cacheEnabled=!0;u.call(this);this.pillarConvex=new f;this.pillarOffset=new r;this.type=u.types.HEIGHTFIELD;this.updateBoundingSphereRadius();this._cachedPillars={}}var u=n("./Shape"),f=n("./ConvexPolyhedron"),r=n("../math/Vec3"),e=n("../utils/Utils");t.exports=i;i.prototype=new u;i.prototype.update=function(){this._cachedPillars={}};i.prototype.updateMinValue=function(){for(var i,u,n=this.data,r=n[0][0],t=0;t!==n.length;t++)for(i=0;i!==n[t].length;i++)u=n[t][i],u<r&&(r=u);this.minValue=r};i.prototype.updateMaxValue=function(){for(var i,u,n=this.data,r=n[0][0],t=0;t!==n.length;t++)for(i=0;i!==n[t].length;i++)u=n[t][i],u>r&&(r=u);this.maxValue=r};i.prototype.setHeightValueAtIndex=function(n,t,i){var r=this.data;r[n][t]=i;this.clearCachedConvexTrianglePillar(n,t,!1);n>0&&(this.clearCachedConvexTrianglePillar(n-1,t,!0),this.clearCachedConvexTrianglePillar(n-1,t,!1));t>0&&(this.clearCachedConvexTrianglePillar(n,t-1,!0),this.clearCachedConvexTrianglePillar(n,t-1,!1));t>0&&n>0&&this.clearCachedConvexTrianglePillar(n-1,t-1,!0)};i.prototype.getRectMinMax=function(n,t,i,r,u){var h,f,e,o,s;for(u=u||[],h=this.data,f=this.minValue,e=n;e<=i;e++)for(o=t;o<=r;o++)s=h[e][o],s>f&&(f=s);u[0]=this.minValue;u[1]=f};i.prototype.getIndexOfPosition=function(n,t,i,r){var o=this.elementSize,e=this.data,u=Math.floor(n/o),f=Math.floor(t/o);return(i[0]=u,i[1]=f,r&&(u<0&&(u=0),f<0&&(f=0),u>=e.length-1&&(u=e.length-1),f>=e[0].length-1&&(f=e[0].length-1)),u<0||f<0||u>=e.length-1||f>=e[0].length-1)?!1:!0};i.prototype.getHeightAt=function(n,t,i){var r=[],u;return this.getIndexOfPosition(n,t,r,i),u=[],this.getRectMinMax(r[0],r[1]+1,r[0],r[1]+1,u),(u[0]+u[1])/2};i.prototype.getCacheConvexTrianglePillarKey=function(n,t,i){return n+"_"+t+"_"+(i?1:0)};i.prototype.getCachedConvexTrianglePillar=function(n,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(n,t,i)]};i.prototype.setCachedConvexTrianglePillar=function(n,t,i,r,u){this._cachedPillars[this.getCacheConvexTrianglePillarKey(n,t,i)]={convex:r,offset:u}};i.prototype.clearCachedConvexTrianglePillar=function(n,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(n,t,i)]};i.prototype.getConvexTrianglePillar=function(n,t,i){var c=this.pillarConvex,a=this.pillarOffset,s,l,h,o;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(n,t,i),s){this.pillarConvex=s.convex;this.pillarOffset=s.offset;return}c=new f;a=new r;this.pillarConvex=c;this.pillarOffset=a}var s=this.data,e=this.elementSize,u=c.faces;for(c.vertices.length=6,l=0;l<6;l++)c.vertices[l]||(c.vertices[l]=new r);for(u.length=5,l=0;l<5;l++)u[l]||(u[l]=[]);h=c.vertices;o=(Math.min(s[n][t],s[n+1][t],s[n][t+1],s[n+1][t+1])-this.minValue)/2+this.minValue;i?(a.set((n+.75)*e,(t+.75)*e,o),h[0].set(.25*e,.25*e,s[n+1][t+1]-o),h[1].set(-.75*e,.25*e,s[n][t+1]-o),h[2].set(.25*e,-.75*e,s[n+1][t]-o),h[3].set(.25*e,.25*e,-o-1),h[4].set(-.75*e,.25*e,-o-1),h[5].set(.25*e,-.75*e,-o-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((n+.25)*e,(t+.25)*e,o),h[0].set(-.25*e,-.25*e,s[n][t]-o),h[1].set(.75*e,-.25*e,s[n+1][t]-o),h[2].set(-.25*e,.75*e,s[n][t+1]-o),h[3].set(-.25*e,-.25*e,-o-1),h[4].set(.75*e,-.25*e,-o-1),h[5].set(-.25*e,.75*e,-o-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1);c.computeNormals();c.computeEdges();c.updateBoundingSphereRadius();this.setCachedConvexTrianglePillar(n,t,i,c,a)};i.prototype.calculateLocalInertia=function(n,t){return t=t||new r,t.set(0,0,0),t};i.prototype.volume=function(){return Number.MAX_VALUE};i.prototype.calculateWorldAABB=function(n,t,i,r){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);r.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};i.prototype.updateBoundingSphereRadius=function(){var n=this.data,t=this.elementSize;this.boundingSphereRadius=new r(n.length*t,n[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(n,t){function i(){r.call(this);this.type=r.types.PARTICLE}t.exports=i;var r=n("./Shape"),u=n("../math/Vec3");i.prototype=new r;i.prototype.constructor=i;i.prototype.calculateLocalInertia=function(n,t){return t=t||new u,t.set(0,0,0),t};i.prototype.volume=function(){return 0};i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0};i.prototype.calculateWorldAABB=function(n,t,i,r){i.copy(n);r.copy(n)}},{"../math/Vec3":30,"./Shape":43}],42:[function(n,t){function r(){u.call(this);this.type=u.types.PLANE;this.worldNormal=new f;this.worldNormalNeedsUpdate=!0;this.boundingSphereRadius=Number.MAX_VALUE}var u,f,i;t.exports=r;u=n("./Shape");f=n("../math/Vec3");r.prototype=new u;r.prototype.constructor=r;r.prototype.computeWorldNormal=function(n){var t=this.worldNormal;t.set(0,0,1);n.vmult(t,t);this.worldNormalNeedsUpdate=!1};r.prototype.calculateLocalInertia=function(n,t){return t||new f};r.prototype.volume=function(){return Number.MAX_VALUE};i=new f;r.prototype.calculateWorldAABB=function(n,t,r,u){i.set(0,0,1);t.vmult(i,i);var f=Number.MAX_VALUE;r.set(-f,-f,-f);u.set(f,f,f);i.x===1&&(u.x=n.x);i.y===1&&(u.y=n.y);i.z===1&&(u.z=n.z);i.x===-1&&(r.x=n.x);i.y===-1&&(r.y=n.y);i.z===-1&&(r.z=n.z)};r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(n,t){function i(){this.id=i.idCounter++;this.type=0;this.boundingSphereRadius=0;this.collisionResponse=!0;this.material=null}t.exports=i;var i=n("./Shape"),r=n("../math/Vec3"),u=n("../math/Quaternion"),f=n("../material/Material");i.prototype.constructor=i;i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type;};i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type;};i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type;};i.idCounter=0;i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(n,t){function i(n){if(r.call(this),this.radius=n!==undefined?Number(n):1,this.type=r.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}t.exports=i;var r=n("./Shape"),u=n("../math/Vec3");i.prototype=new r;i.prototype.constructor=i;i.prototype.calculateLocalInertia=function(n,t){t=t||new u;var i=2*n*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t};i.prototype.volume=function(){return 4*Math.PI*this.radius/3};i.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius};i.prototype.calculateWorldAABB=function(n,t,i,r){for(var u,e=this.radius,o=["x","y","z"],f=0;f<o.length;f++)u=o[f],i[u]=n[u]-e,r[u]=n[u]+e}},{"../math/Vec3":30,"./Shape":43}],45:[function(n,t){function i(n,t){o.call(this);this.type=o.types.TRIMESH;this.vertices=new Float32Array(n);this.indices=new Int16Array(t);this.normals=new Float32Array(t.length);this.aabb=new f;this.edges=null;this.scale=new r(1,1,1);this.tree=new k;this.updateEdges();this.updateNormals();this.updateAABB();this.updateBoundingSphereRadius();this.updateTree()}var l,e,a,v,s,h,u,b;t.exports=i;var o=n("./Shape"),r=n("../math/Vec3"),nt=n("../math/Quaternion"),c=n("../math/Transform"),f=n("../collision/AABB"),k=n("../utils/Octree");i.prototype=new o;i.prototype.constructor=i;l=new r;i.prototype.updateTree=function(){var n=this.tree,t,i,u;n.reset();n.aabb.copy(this.aabb);t=this.scale;n.aabb.lowerBound.x*=1/t.x;n.aabb.lowerBound.y*=1/t.y;n.aabb.lowerBound.z*=1/t.z;n.aabb.upperBound.x*=1/t.x;n.aabb.upperBound.y*=1/t.y;n.aabb.upperBound.z*=1/t.z;var e=new f,o=new r,s=new r,h=new r,c=[o,s,h];for(i=0;i<this.indices.length/3;i++)u=i*3,this._getUnscaledVertex(this.indices[u],o),this._getUnscaledVertex(this.indices[u+1],s),this._getUnscaledVertex(this.indices[u+2],h),e.setFromPoints(c),n.insert(e,i);n.removeEmptyNodes()};e=new f;i.prototype.getTrianglesInAABB=function(n,t){e.copy(n);var i=this.scale,f=i.x,o=i.y,s=i.z,r=e.lowerBound,u=e.upperBound;return r.x/=f,r.y/=o,r.z/=s,u.x/=f,u.y/=o,u.z/=s,this.tree.aabbQuery(e,t)};i.prototype.setScale=function(n){var t=this.scale.x===this.scale.y===this.scale.z,i=n.x===n.y===n.z;t&&i||this.updateNormals();this.scale.copy(n);this.updateAABB();this.updateBoundingSphereRadius()};i.prototype.updateNormals=function(){for(var t=l,r=this.normals,u=0;u<this.indices.length/3;u++){var n=u*3,f=this.indices[n],e=this.indices[n+1],o=this.indices[n+2];this.getVertex(f,y);this.getVertex(e,p);this.getVertex(o,w);i.computeNormal(p,y,w,t);r[n]=t.x;r[n+1]=t.y;r[n+2]=t.z}};i.prototype.updateEdges=function(){for(var r,e,o={},u=function(){var n=t<i?t+"_"+i:i+"_"+t;o[n]=!0},n=0;n<this.indices.length/3;n++){var f=n*3,t=this.indices[f],i=this.indices[f+1],s=this.indices[f+2];u(t,i);u(i,s);u(s,t)}for(r=Object.keys(o),this.edges=new Int16Array(r.length*2),n=0;n<r.length;n++)e=r[n].split("_"),this.edges[2*n]=parseInt(e[0],10),this.edges[2*n+1]=parseInt(e[1],10)};i.prototype.getEdgeVertex=function(n,t,i){var r=this.edges[n*2+(t?1:0)];this.getVertex(r,i)};a=new r;v=new r;i.prototype.getEdgeVector=function(n,t){var i=a,r=v;this.getEdgeVertex(n,0,i);this.getEdgeVertex(n,1,r);r.vsub(i,t)};s=new r;h=new r;i.computeNormal=function(n,t,i,r){t.vsub(n,h);i.vsub(t,s);s.cross(h,r);r.isZero()||r.normalize()};var y=new r,p=new r,w=new r;i.prototype.getVertex=function(n,t){var i=this.scale;return this._getUnscaledVertex(n,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t};i.prototype._getUnscaledVertex=function(n,t){var i=n*3,r=this.vertices;return t.set(r[i],r[i+1],r[i+2])};i.prototype.getWorldVertex=function(n,t,i,r){return this.getVertex(n,r),c.pointToWorldFrame(t,i,r,r),r};i.prototype.getTriangleVertices=function(n,t,i,r){var u=n*3;this.getVertex(this.indices[u],t);this.getVertex(this.indices[u+1],i);this.getVertex(this.indices[u+2],r)};i.prototype.getNormal=function(n,t){var i=n*3;return t.set(this.normals[i],this.normals[i+1],this.normals[i+2])};u=new f;i.prototype.calculateLocalInertia=function(n,t){this.computeLocalAABB(u);var i=u.upperBound.x-u.lowerBound.x,r=u.upperBound.y-u.lowerBound.y,f=u.upperBound.z-u.lowerBound.z;return t.set(1/12*n*(4*r*r+4*f*f),1/12*n*(4*i*i+4*f*f),1/12*n*(4*r*r+4*i*i))};b=new r;i.prototype.computeLocalAABB=function(n){var i=n.lowerBound,r=n.upperBound,f=this.vertices.length,e=this.vertices,t=b,u;for(this.getVertex(0,t),i.copy(t),r.copy(t),u=0;u!==f;u++)this.getVertex(u,t),t.x<i.x?i.x=t.x:t.x>r.x&&(r.x=t.x),t.y<i.y?i.y=t.y:t.y>r.y&&(r.y=t.y),t.z<i.z?i.z=t.z:t.z>r.z&&(r.z=t.z)};i.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)};i.prototype.updateBoundingSphereRadius=function(){for(var i,n=0,f=this.vertices,u=new r,t=0,e=f.length/3;t!==e;t++)this.getVertex(t,u),i=u.norm2(),i>n&&(n=i);this.boundingSphereRadius=Math.sqrt(n)};var tt=new r,d=new c,g=new f;i.prototype.calculateWorldAABB=function(n,t,i,r){var u=d,f=g;u.position=n;u.quaternion=t;this.aabb.toWorldFrame(u,f);i.copy(f.lowerBound);r.copy(f.upperBound)};i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3};i.createTorus=function(n,t,r,u,f){var h,s,e,o;for(n=n||1,t=t||.5,r=r||8,u=u||6,f=f||Math.PI*2,h=[],s=[],e=0;e<=r;e++)for(o=0;o<=u;o++){var l=o/u*f,c=e/r*Math.PI*2,y=(n+t*Math.cos(c))*Math.cos(l),p=(n+t*Math.cos(c))*Math.sin(l),w=t*Math.sin(c);h.push(y,p,w)}for(e=1;e<=r;e++)for(o=1;o<=u;o++){var b=(u+1)*e+o-1,a=(u+1)*(e-1)+o-1,k=(u+1)*(e-1)+o,v=(u+1)*e+o;s.push(b,a,v);s.push(a,k,v)}return new i(h,s)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(n,t){function i(){r.call(this);this.iterations=10;this.tolerance=1e-7}t.exports=i;var o=n("../math/Vec3"),s=n("../math/Quaternion"),r=n("./Solver");i.prototype=new r;var u=[],f=[],e=[];i.prototype.solve=function(n,t){var a=0,ft=this.iterations,et=this.tolerance*this.tolerance,w=this.equations,h=w.length,v=t.bodies,b=v.length,ot=n,nt,tt,o,y,it,c,s,r,i;if(h!==0)for(i=0;i!==b;i++)v[i].updateSolveMassProperties();var k=f,d=e,p=u;for(k.length=h,d.length=h,p.length=h,i=0;i!==h;i++)r=w[i],p[i]=0,d[i]=r.computeB(ot),k[i]=1/r.computeC();if(h!==0){for(i=0;i!==b;i++){var l=v[i],st=l.vlambda,rt=l.wlambda;st.set(0,0,0);rt&&rt.set(0,0,0)}for(a=0;a!==ft;a++){for(y=0,s=0;s!==h;s++)r=w[s],nt=d[s],tt=k[s],c=p[s],it=r.computeGWlambda(),o=tt*(nt-it-r.eps*c),c+o<r.minForce?o=r.minForce-c:c+o>r.maxForce&&(o=r.maxForce-c),p[s]+=o,y+=o>0?o:-o,r.addToWlambda(o);if(y*y<et)break}for(i=0;i!==b;i++){var l=v[i],ut=l.velocity,g=l.angularVelocity;ut.vadd(l.vlambda,ut);g&&g.vadd(l.wlambda,g)}}return a}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(n,t){function i(){this.equations=[]}t.exports=i;i.prototype.solve=function(){return 0};i.prototype.addEquation=function(n){n.enabled&&this.equations.push(n)};i.prototype.removeEquation=function(n){var t=this.equations,i=t.indexOf(n);i!==-1&&t.splice(i,1)};i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(n,t){function r(n){for(u.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=n,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}function f(n){for(var t,r=n.length,i=0;i!==r;i++)if(t=n[i],!t.visited&&!(t.body.type&c))return t;return!1}function l(n,t,r,u){for(i.push(n),n.visited=!0,t(n,r,u);i.length;)for(var o=i.pop(),e;e=f(o.children);)e.visited=!0,t(e,r,u),i.push(e)}function a(n,t,i){var f,r,u;for(t.push(n.body),f=n.eqs.length,r=0;r!==f;r++)u=n.eqs[r],i.indexOf(u)===-1&&i.push(u)}function v(n,t){return t.id-n.id}var i;t.exports=r;var y=n("../math/Vec3"),p=n("../math/Quaternion"),u=n("./Solver"),e=n("../objects/Body");r.prototype=new u;var o=[],s=[],h={bodies:[]},c=e.STATIC;i=[];r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}};r.prototype.solve=function(n,t){for(var u=o,d=this.nodePool,y=t.bodies,it=this.equations,ft=it.length,p=y.length,e=this.subsolver,c,w,rt,tt,r,k,ut,i,ot;d.length<p;)d.push(this.createNode());for(u.length=p,i=0;i<p;i++)u[i]=d[i];for(i=0;i!==p;i++)c=u[i],c.body=y[i],c.children.length=0,c.eqs.length=0,c.visited=!1;for(w=0;w!==ft;w++){var b=it[w],i=y.indexOf(b.bi),et=y.indexOf(b.bj),g=u[i],nt=u[et];g.children.push(nt);g.eqs.push(b);nt.children.push(g);nt.eqs.push(b)}for(tt=0,r=s,e.tolerance=this.tolerance,e.iterations=this.iterations,k=h;rt=f(u);){for(r.length=0,k.bodies.length=0,l(rt,a,k.bodies,r),ut=r.length,r=r.sort(v),i=0;i!==ut;i++)e.addEquation(r[i]);ot=e.solve(n,k);e.removeAllEquations();tt++}return tt}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(n,t){var i=function(){};t.exports=i;i.prototype={constructor:i,addEventListener:function(n,t){this._listeners===undefined&&(this._listeners={});var i=this._listeners;return i[n]===undefined&&(i[n]=[]),i[n].indexOf(t)===-1&&i[n].push(t),this},hasEventListener:function(n,t){if(this._listeners===undefined)return!1;var i=this._listeners;return i[n]!==undefined&&i[n].indexOf(t)!==-1?!0:!1},removeEventListener:function(n,t){var i,r;return this._listeners===undefined?this:(i=this._listeners,i[n]===undefined)?this:(r=i[n].indexOf(t),r!==-1&&i[n].splice(r,1),this)},dispatchEvent:function(n){var r,t,i,u;if(this._listeners===undefined)return this;if(r=this._listeners,t=r[n.type],t!==undefined)for(n.target=this,i=0,u=t.length;i<u;i++)t[i].call(this,n);return this}}},{}],50:[function(n,t){function i(n){n=n||{};this.root=n.root||null;this.aabb=n.aabb?n.aabb.clone():new r;this.data=[];this.children=[]}function o(n,t){t=t||{};t.root=null;t.aabb=n;i.call(this,t);this.maxDepth=typeof t.maxDepth!="undefined"?t.maxDepth:8}var r=n("../collision/AABB"),u=n("../math/Vec3"),f,e;t.exports=o;o.prototype=new i;i.prototype.reset=function(){this.children.length=this.data.length=0};i.prototype.insert=function(n,t,i){var e=this.data,r,f,u;if(i=i||0,!this.aabb.contains(n))return!1;if(r=this.children,i<(this.maxDepth||this.root.maxDepth)){for(f=!1,r.length||(this.subdivide(),f=!0),u=0;u!==8;u++)if(r[u].insert(n,t,i+1))return!0;f&&(r.length=0)}return e.push(t),!0};f=new u;i.prototype.subdivide=function(){var o=this.aabb,s=o.lowerBound,l=o.upperBound,h=this.children,c,t,e,n;for(h.push(new i({aabb:new r({lowerBound:new u(0,0,0)})}),new i({aabb:new r({lowerBound:new u(1,0,0)})}),new i({aabb:new r({lowerBound:new u(1,1,0)})}),new i({aabb:new r({lowerBound:new u(1,1,1)})}),new i({aabb:new r({lowerBound:new u(0,1,1)})}),new i({aabb:new r({lowerBound:new u(0,0,1)})}),new i({aabb:new r({lowerBound:new u(1,0,1)})}),new i({aabb:new r({lowerBound:new u(0,1,0)})})),l.vsub(s,f),f.scale(.5,f),c=this.root||this,t=0;t!==8;t++)e=h[t],e.root=c,n=e.aabb.lowerBound,n.x*=f.x,n.y*=f.y,n.z*=f.z,n.vadd(s,n),n.vadd(f,e.aabb.upperBound)};i.prototype.aabbQuery=function(n,t){for(var u=this.data,f=this.children,r=[this],i;r.length;)i=r.pop(),i.aabb.overlaps(n)&&Array.prototype.push.apply(t,i.data),Array.prototype.push.apply(r,i.children);return t};e=new r;i.prototype.rayQuery=function(n,t,i){return n.getAABB(e),e.toLocalFrame(t,e),this.aabbQuery(e,i),i};i.prototype.removeEmptyNodes=function(){for(var i=[this],n,t;i.length;){for(n=i.pop(),t=n.children.length-1;t>=0;t--)n.children[t].data.length||n.children.splice(t,1);Array.prototype.push.apply(i,n.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(n,t){function i(){this.objects=[];this.type=Object}t.exports=i;i.prototype.release=function(){for(var t=arguments.length,n=0;n!==t;n++)this.objects.push(arguments[n])};i.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()};i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!");}},{}],52:[function(n,t){function i(){this.data={keys:[]}}t.exports=i;i.prototype.get=function(n,t){if(n>t){var i=t;t=n;n=i}return this.data[n+"-"+t]};i.prototype.set=function(n,t,i){var u,r;n>t&&(u=t,t=n,n=u);r=n+"-"+t;this.get(n,t)||this.data.keys.push(r);this.data[r]=i};i.prototype.reset=function(){for(var n=this.data,t=n.keys,i;t.length>0;)i=t.pop(),delete n[i]}},{}],53:[function(n,t){function i(){}t.exports=i;i.defaults=function(n,t){n=n||{};for(var i in t)i in n||(n[i]=t[i]);return n}},{}],54:[function(n,t){function i(){u.call(this);this.type=r}t.exports=i;var r=n("../math/Vec3"),u=n("./Pool");i.prototype=new u;i.prototype.constructObject=function(){return new r}},{"../math/Vec3":30,"./Pool":51}],55:[function(n,t){function r(n){this.contactPointPool=[];this.frictionEquationPool=[];this.result=[];this.frictionResult=[];this.v3pool=new ut;this.world=n;this.currentContactMaterial=null;this.enableFrictionReduction=!1}function ci(n,t,i){for(var e,o,s,h,f,r=null,c=n.length,u=0;u!==c;u++)if(e=n[u],o=oi,n[(u+1)%c].vsub(e,o),s=si,o.cross(t,s),h=hi,i.vsub(e,h),f=s.dot(h),r===null||f>0&&r===!0||f<=0&&r===!1){r===null&&(r=f>0);continue}else return!1;return!0}var a,p,h,v,sr,hr,w,b,k,nt,tt;t.exports=r;var it=n("../collision/AABB"),u=n("../shapes/Shape"),rt=n("../collision/Ray"),i=n("../math/Vec3"),f=n("../math/Transform"),iu=n("../shapes/ConvexPolyhedron"),l=n("../math/Quaternion"),ru=n("../solver/Solver"),ut=n("../utils/Vec3Pool"),ft=n("../equations/ContactEquation"),y=n("../equations/FrictionEquation");r.prototype.createContactEquation=function(n,t,i,r,u,f){var e,o,s,h;return this.contactPointPool.length?(e=this.contactPointPool.pop(),e.bi=n,e.bj=t):e=new ft(n,t),e.enabled=n.collisionResponse&&t.collisionResponse&&i.collisionResponse&&r.collisionResponse,o=this.currentContactMaterial,e.restitution=o.restitution,e.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt),s=i.material||n.material,h=r.material||t.material,s&&h&&s.restitution>=0&&h.restitution>=0&&(e.restitution=s.restitution*h.restitution),e.si=u||i,e.sj=f||r,e};r.prototype.createFrictionEquationsFromContact=function(n,t){var f=n.bi,e=n.bj,p=n.si,w=n.sj,c=this.world,o=this.currentContactMaterial,l=o.friction,a=p.material||f.material,v=w.material||e.material,s,u;if(a&&v&&a.friction>=0&&v.friction>=0&&(l=a.friction*v.friction),l>0){s=l*c.gravity.length();u=f.invMass+e.invMass;u>0&&(u=1/u);var h=this.frictionEquationPool,i=h.length?h.pop():new y(f,e,s*u),r=h.length?h.pop():new y(f,e,s*u);return i.bi=r.bi=f,i.bj=r.bj=e,i.minForce=r.minForce=-s*u,i.maxForce=r.maxForce=s*u,i.ri.copy(n.ri),i.rj.copy(n.rj),r.ri.copy(n.ri),r.rj.copy(n.rj),n.ni.tangents(i.t,r.t),i.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,c.dt),r.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,c.dt),i.enabled=r.enabled=n.enabled,t.push(i,r),!0}return!1};var e=new i,o=new i,s=new i;r.prototype.createFrictionFromAverage=function(n){var t=this.result[this.result.length-1],i,r,h,c,u,f;if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&n!==1){for(i=this.frictionResult[this.frictionResult.length-2],r=this.frictionResult[this.frictionResult.length-1],e.setZero(),o.setZero(),s.setZero(),h=t.bi,c=t.bj,u=0;u!==n;u++)t=this.result[this.result.length-1-u],t.bodyA!==h?(e.vadd(t.ni,e),o.vadd(t.ri,o),s.vadd(t.rj,s)):(e.vsub(t.ni,e),o.vadd(t.rj,o),s.vadd(t.ri,s));f=1/n;o.scale(f,i.ri);s.scale(f,i.rj);r.ri.copy(i.ri);r.rj.copy(i.rj);e.normalize();e.tangents(i.t,r.t)}};var et=new i,ot=new i,st=new l,ht=new l;r.prototype.getContacts=function(n,t,i,r,u,f,e){var p,g,v,h,y,c,d,w;this.contactPointPool=u;this.frictionEquationPool=e;this.result=r;this.frictionResult=f;var b=st,k=ht,l=et,a=ot;for(p=0,g=n.length;p!==g;p++){var o=n[p],s=t[p],nt=null;for(o.material&&s.material&&(nt=i.getContactMaterial(o.material,s.material)||null),v=0;v<o.shapes.length;v++)for(o.quaternion.mult(o.shapeOrientations[v],b),o.quaternion.vmult(o.shapeOffsets[v],l),l.vadd(o.position,l),h=o.shapes[v],y=0;y<s.shapes.length;y++)(s.quaternion.mult(s.shapeOrientations[y],k),s.quaternion.vmult(s.shapeOffsets[y],a),a.vadd(s.position,a),c=s.shapes[y],l.distanceTo(a)>h.boundingSphereRadius+c.boundingSphereRadius)||(d=null,h.material&&c.material&&(d=i.getContactMaterial(h.material,c.material)||null),this.currentContactMaterial=d||nt||i.defaultContactMaterial,w=this[h.type|c.type],w&&(h.type<c.type?w.call(this,h,c,l,a,b,k,o,s,h,c):w.call(this,c,h,a,l,k,b,s,o,h,c)))}};a=0;p=10;r.prototype[u.types.BOX|u.types.BOX]=r.prototype.boxBox=function(n,t,i,r,u,f,e,o){n.convexPolyhedronRepresentation.material=n.material;t.convexPolyhedronRepresentation.material=t.material;n.convexPolyhedronRepresentation.collisionResponse=n.collisionResponse;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.convexConvex(n.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,r,u,f,e,o,n,t)};r.prototype[u.types.BOX|u.types.CONVEXPOLYHEDRON]=r.prototype.boxConvex=function(n,t,i,r,u,f,e,o){n.convexPolyhedronRepresentation.material=n.material;n.convexPolyhedronRepresentation.collisionResponse=n.collisionResponse;this.convexConvex(n.convexPolyhedronRepresentation,t,i,r,u,f,e,o,n,t)};r.prototype[u.types.BOX|u.types.PARTICLE]=r.prototype.boxParticle=function(n,t,i,r,u,f,e,o){n.convexPolyhedronRepresentation.material=n.material;n.convexPolyhedronRepresentation.collisionResponse=n.collisionResponse;this.convexParticle(n.convexPolyhedronRepresentation,t,i,r,u,f,e,o,n,t)};r.prototype[u.types.SPHERE]=r.prototype.sphereSphere=function(n,t,i,r,u,f,e,o){var s=this.createContactEquation(e,o,n,t);r.vsub(i,s.ni);s.ni.normalize();s.ri.copy(s.ni);s.rj.copy(s.ni);s.ri.mult(n.radius,s.ri);s.rj.mult(-t.radius,s.rj);s.ri.vadd(i,s.ri);s.ri.vsub(e.position,s.ri);s.rj.vadd(r,s.rj);s.rj.vsub(o.position,s.rj);this.result.push(s);this.createFrictionEquationsFromContact(s,this.frictionResult)};var ct=new i,lt=new i,at=new i;r.prototype[u.types.PLANE|u.types.TRIMESH]=r.prototype.planeTrimesh=function(n,t,r,u,e,o,s,h){var a=new i,l=ct,y,w,p,b,c,v;for(l.set(0,0,1),e.vmult(l,l),y=0;y<t.vertices.length/3;y++)t.getVertex(y,a),w=new i,w.copy(a),f.pointToWorldFrame(u,o,w,a),p=lt,a.vsub(r,p),b=l.dot(p),b<=0&&(c=this.createContactEquation(s,h,n,t),c.ni.copy(l),v=at,l.scale(p.dot(l),v),a.vsub(v,v),c.ri.copy(v),c.ri.vsub(s.position,c.ri),c.rj.copy(a),c.rj.vsub(h.position,c.rj),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult))};var vt=new i,yt=new i,fu=new i,pt=new i,wt=new i,bt=new i,kt=new i,dt=new i,gt=new i,ni=new i,ti=new i,ii=new i,ri=new i,ui=new i,fi=new it,ei=[];r.prototype[u.types.SPHERE|u.types.TRIMESH]=r.prototype.sphereTrimesh=function(n,t,i,r,u,e,o,s){var k=bt,it=kt,d=dt,g=gt,l=ni,c=ti,ut=fi,ot=wt,nt=yt,v=ei,p,w,st,y,ht,tt,a,at,b,h;for(f.pointToLocalFrame(r,e,i,l),p=n.radius,ut.lowerBound.set(l.x-p,l.y-p,l.z-p),ut.upperBound.set(l.x+p,l.y+p,l.z+p),t.getTrianglesInAABB(ut,v),w=pt,st=n.radius*n.radius,a=0;a<v.length;a++)for(y=0;y<3;y++)t.getVertex(t.indices[v[a]*3+y],w),w.vsub(l,nt),nt.norm2()<=st&&(ot.copy(w),f.pointToWorldFrame(r,e,ot,w),w.vsub(i,nt),h=this.createContactEquation(o,s,n,t),h.ni.copy(nt),h.ni.normalize(),h.ri.copy(h.ni),h.ri.scale(n.radius,h.ri),h.ri.vadd(i,h.ri),h.ri.vsub(o.position,h.ri),h.rj.copy(w),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult));for(a=0;a<v.length;a++)for(y=0;y<3;y++)t.getVertex(t.indices[v[a]*3+y],k),t.getVertex(t.indices[v[a]*3+(y+1)%3],it),it.vsub(k,d),l.vsub(it,c),ht=c.dot(d),l.vsub(k,c),tt=c.dot(d),tt>0&&ht<0&&(l.vsub(k,c),g.copy(d),g.normalize(),tt=c.dot(g),g.scale(tt,c),c.vadd(k,c),b=c.distanceTo(l),b<n.radius&&(h=this.createContactEquation(o,s,n,t),c.vsub(l,h.ni),h.ni.normalize(),h.ni.scale(n.radius,h.ri),f.pointToWorldFrame(r,e,c,c),c.vsub(s.position,h.rj),f.vectorToWorldFrame(e,h.ni,h.ni),f.vectorToWorldFrame(e,h.ri,h.ri),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)));var ft=ii,ct=ri,lt=ui,et=vt;for(a=0,at=v.length;a!==at;a++)t.getTriangleVertices(v[a],ft,ct,lt),t.getNormal(v[a],et),l.vsub(ft,c),b=c.dot(et),et.scale(b,c),l.vsub(c,c),b=c.distanceTo(l),rt.pointInTriangle(c,ft,ct,lt)&&b<n.radius&&(h=this.createContactEquation(o,s,n,t),c.vsub(l,h.ni),h.ni.normalize(),h.ni.scale(n.radius,h.ri),f.pointToWorldFrame(r,e,c,c),c.vsub(s.position,h.rj),f.vectorToWorldFrame(e,h.ni,h.ni),f.vectorToWorldFrame(e,h.ri,h.ri),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult));v.length=0};h=new i;v=new i;r.prototype[u.types.SPHERE|u.types.PLANE]=r.prototype.spherePlane=function(n,t,i,r,u,f,e,o){var s=this.createContactEquation(e,o,n,t),c,l;s.ni.set(0,0,1);f.vmult(s.ni,s.ni);s.ni.negate(s.ni);s.ni.normalize();s.ni.mult(n.radius,s.ri);i.vsub(r,h);s.ni.mult(s.ni.dot(h),v);h.vsub(v,s.rj);-h.dot(s.ni)<=n.radius&&(c=s.ri,l=s.rj,c.vadd(i,c),c.vsub(e.position,c),l.vadd(r,l),l.vsub(o.position,l),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult))};var oi=new i,si=new i,hi=new i;var c=new i,li=new i,ai=new i,vi=new i,yi=[new i,new i,new i,new i,new i,new i],pi=new i,wi=new i,bi=new i,ki=new i;r.prototype[u.types.SPHERE|u.types.BOX]=r.prototype.sphereBox=function(n,t,i,r,u,f,e,o){var k=this.v3pool,a=yi,nt,ti,tt,ht,ct,it,rt,pt,wt,lt,at,v,l,ut,s,y,p,bt,b,ri,ui,h;i.vsub(r,c);t.getSideNormals(a,f);var d=n.radius,w=!1,g=wi,ot=bi,st=ki,kt=null,dt=0,gt=0,ni=0,yt=null;for(nt=0,ti=a.length;nt!==ti&&w===!1;nt++)tt=li,tt.copy(a[nt]),ht=tt.norm(),tt.normalize(),ct=c.dot(tt),ct<ht+d&&ct>0&&(it=ai,rt=vi,it.copy(a[(nt+1)%3]),rt.copy(a[(nt+2)%3]),pt=it.norm(),wt=rt.norm(),it.normalize(),rt.normalize(),lt=c.dot(it),at=c.dot(rt),lt<pt&&lt>-pt&&at<wt&&at>-wt&&(v=Math.abs(ct-ht-d),(yt===null||v<yt)&&(yt=v,gt=lt,ni=at,kt=ht,g.copy(tt),ot.copy(it),st.copy(rt),dt++)));for(dt&&(w=!0,s=this.createContactEquation(e,o,n,t),g.mult(-d,s.ri),s.ni.copy(g),s.ni.negate(s.ni),g.mult(kt,g),ot.mult(gt,ot),g.vadd(ot,g),st.mult(ni,st),g.vadd(st,s.rj),s.ri.vadd(i,s.ri),s.ri.vsub(e.position,s.ri),s.rj.vadd(r,s.rj),s.rj.vsub(o.position,s.rj),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult)),l=k.get(),ut=pi,y=0;y!==2&&!w;y++)for(p=0;p!==2&&!w;p++)for(b=0;b!==2&&!w;b++)l.set(0,0,0),y?l.vadd(a[0],l):l.vsub(a[0],l),p?l.vadd(a[1],l):l.vsub(a[1],l),b?l.vadd(a[2],l):l.vsub(a[2],l),r.vadd(l,ut),ut.vsub(i,ut),ut.norm2()<d*d&&(w=!0,s=this.createContactEquation(e,o,n,t),s.ri.copy(ut),s.ri.normalize(),s.ni.copy(s.ri),s.ri.mult(d,s.ri),s.rj.copy(l),s.ri.vadd(i,s.ri),s.ri.vsub(e.position,s.ri),s.rj.vadd(r,s.rj),s.rj.vsub(o.position,s.rj),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult));k.release(l);l=null;var ft=k.get(),et=k.get(),s=k.get(),vt=k.get(),v=k.get(),ii=a.length;for(y=0;y!==ii&&!w;y++)for(p=0;p!==ii&&!w;p++)if(y%3!=p%3){for(a[p].cross(a[y],ft),ft.normalize(),a[y].vadd(a[p],et),s.copy(i),s.vsub(et,s),s.vsub(r,s),bt=s.dot(ft),ft.mult(bt,vt),b=0;b===y%3||b===p%3;)b++;v.copy(i);v.vsub(vt,v);v.vsub(et,v);v.vsub(r,v);ri=Math.abs(bt);ui=v.norm();ri<a[b].norm()&&ui<d&&(w=!0,h=this.createContactEquation(e,o,n,t),et.vadd(vt,h.rj),h.rj.copy(h.rj),v.negate(h.ni),h.ni.normalize(),h.ri.copy(h.rj),h.ri.vadd(r,h.ri),h.ri.vsub(i,h.ri),h.ri.normalize(),h.ri.mult(d,h.ri),h.ri.vadd(i,h.ri),h.ri.vsub(e.position,h.ri),h.rj.vadd(r,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult))}k.release(ft,et,s,vt,v)};var di=new i,gi=new i,nr=new i,tr=new i,ir=new i,rr=new i,ur=new i,fr=new i,er=new i,or=new i;r.prototype[u.types.SPHERE|u.types.CONVEXPOLYHEDRON]=r.prototype.sphereConvex=function(n,t,i,r,u,f,e,o){var h=this.v3pool,bt,g,ot,st,a,kt,nt,it,vt,yt,pt,y,dt,rt,ht,ct,p,k,lt,at,w,ut,ft,et,s,c,tt;i.vsub(r,di);var gt=t.faceNormals,wt=t.faces,d=t.vertices,l=n.radius;for(a=0;a!==d.length;a++)if(bt=d[a],g=ir,f.vmult(bt,g),r.vadd(g,g),ot=tr,g.vsub(i,ot),ot.norm2()<l*l){st=!0;s=this.createContactEquation(e,o,n,t);s.ri.copy(ot);s.ri.normalize();s.ni.copy(s.ri);s.ri.mult(l,s.ri);g.vsub(r,s.rj);s.ri.vadd(i,s.ri);s.ri.vsub(e.position,s.ri);s.rj.vadd(r,s.rj);s.rj.vsub(o.position,s.rj);this.result.push(s);this.createFrictionEquationsFromContact(s,this.frictionResult);return}for(st=!1,a=0,kt=wt.length;a!==kt&&st===!1;a++){var ni=gt[a],b=wt[a],v=rr;if(f.vmult(ni,v),nt=ur,f.vmult(d[b[0]],nt),nt.vadd(r,nt),it=fr,v.mult(-l,it),i.vadd(it,it),vt=er,it.vsub(nt,vt),yt=vt.dot(v),pt=or,i.vsub(nt,pt),yt<0&&pt.dot(v)>0){for(y=[],c=0,dt=b.length;c!==dt;c++)rt=h.get(),f.vmult(d[b[c]],rt),r.vadd(rt,rt),y.push(rt);if(ci(y,v,i)){for(st=!0,s=this.createContactEquation(e,o,n,t),v.mult(-l,s.ri),v.negate(s.ni),ht=h.get(),v.mult(-yt,ht),ct=h.get(),v.mult(-l,ct),i.vsub(r,s.rj),s.rj.vadd(ct,s.rj),s.rj.vadd(ht,s.rj),s.rj.vadd(r,s.rj),s.rj.vsub(o.position,s.rj),s.ri.vadd(i,s.ri),s.ri.vsub(e.position,s.ri),h.release(ht),h.release(ct),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult),c=0,tt=y.length;c!==tt;c++)h.release(y[c]);return}for(c=0;c!==b.length;c++){if(p=h.get(),k=h.get(),f.vmult(d[b[(c+1)%b.length]],p),f.vmult(d[b[(c+2)%b.length]],k),r.vadd(p,p),r.vadd(k,k),lt=gi,k.vsub(p,lt),at=nr,lt.unit(at),w=h.get(),ut=h.get(),i.vsub(p,ut),ft=ut.dot(at),at.mult(ft,w),w.vadd(p,w),et=h.get(),w.vsub(i,et),ft>0&&ft*ft<lt.norm2()&&et.norm2()<l*l){for(s=this.createContactEquation(e,o,n,t),w.vsub(r,s.rj),w.vsub(i,s.ni),s.ni.normalize(),s.ni.mult(l,s.ri),s.rj.vadd(r,s.rj),s.rj.vsub(o.position,s.rj),s.ri.vadd(i,s.ri),s.ri.vsub(e.position,s.ri),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult),c=0,tt=y.length;c!==tt;c++)h.release(y[c]);h.release(p);h.release(k);h.release(w);h.release(et);h.release(ut);return}h.release(p);h.release(k);h.release(w);h.release(et);h.release(ut)}for(c=0,tt=y.length;c!==tt;c++)h.release(y[c])}}};sr=new i;hr=new i;r.prototype[u.types.PLANE|u.types.BOX]=r.prototype.planeBox=function(n,t,i,r,u,f,e,o){t.convexPolyhedronRepresentation.material=t.material;t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse;this.planeConvex(n,t.convexPolyhedronRepresentation,i,r,u,f,e,o)};var cr=new i,lr=new i,ar=new i,vr=new i;r.prototype[u.types.PLANE|u.types.CONVEXPOLYHEDRON]=r.prototype.planeConvex=function(n,t,i,r,u,f,e,o){var h=cr,c=lr,a,v,y,p,s,l;for(c.set(0,0,1),u.vmult(c,c),a=0,v=ar,y=0;y!==t.vertices.length;y++)h.copy(t.vertices[y]),f.vmult(h,h),r.vadd(h,h),h.vsub(i,v),p=c.dot(v),p<=0&&(s=this.createContactEquation(e,o,n,t),l=vr,c.mult(c.dot(v),l),h.vsub(l,l),l.vsub(i,s.ri),s.ni.copy(c),h.vsub(r,s.rj),s.ri.vadd(i,s.ri),s.ri.vsub(e.position,s.ri),s.rj.vadd(r,s.rj),s.rj.vsub(o.position,s.rj),this.result.push(s),a++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(s,this.frictionResult));this.enableFrictionReduction&&a&&this.createFrictionFromAverage(a)};w=new i;b=new i;r.prototype[u.types.CONVEXPOLYHEDRON]=r.prototype.convexConvex=function(n,t,i,r,u,f,e,o,s,h,c,l){var nt=w,a,k,g,v;if(!(i.distanceTo(r)>n.boundingSphereRadius+t.boundingSphereRadius)&&n.findSeparatingAxis(t,i,u,r,f,nt,c,l)){for(a=[],k=b,n.clipAgainstHull(i,u,t,r,f,nt,-100,100,a),g=0,v=0;v!==a.length;v++){var d=this.createContactEquation(e,o,n,t,s,h),y=d.ri,p=d.rj;nt.negate(d.ni);a[v].normal.negate(k);k.mult(a[v].depth,k);a[v].point.vadd(k,y);p.copy(a[v].point);y.vsub(i,y);p.vsub(r,p);y.vadd(i,y);y.vsub(e.position,y);p.vadd(r,p);p.vsub(o.position,p);this.result.push(d);g++;this.enableFrictionReduction||this.createFrictionEquationsFromContact(d,this.frictionResult)}this.enableFrictionReduction&&g&&this.createFrictionFromAverage(g)}};var yr=new i,pr=new i,wr=new i;r.prototype[u.types.PLANE|u.types.PARTICLE]=r.prototype.planeParticle=function(n,t,i,r,u,f,e,o){var h=yr,l,a,s,c;h.set(0,0,1);e.quaternion.vmult(h,h);l=pr;r.vsub(e.position,l);a=h.dot(l);a<=0&&(s=this.createContactEquation(o,e,t,n),s.ni.copy(h),s.ni.negate(s.ni),s.ri.set(0,0,0),c=wr,h.mult(h.dot(r),c),r.vsub(c,c),s.rj.copy(c),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult))};k=new i;r.prototype[u.types.PARTICLE|u.types.SPHERE]=r.prototype.sphereParticle=function(n,t,i,r,u,f,e,o){var h=k,c,s;h.set(0,0,1);r.vsub(i,h);c=h.norm2();c<=n.radius*n.radius&&(s=this.createContactEquation(o,e,t,n),h.normalize(),s.rj.copy(h),s.rj.mult(n.radius,s.rj),s.ni.copy(h),s.ni.negate(s.ni),s.ri.set(0,0,0),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult))};var d=new l,br=new i,eu=new i,kr=new i,g=new i,dr=new i;r.prototype[u.types.PARTICLE|u.types.CONVEXPOLYHEDRON]=r.prototype.convexParticle=function(n,t,i,r,u,f,e,o){var k=-1,p=kr,h=dr,y=null,it=0,c=br,l,nt,tt,w,b,s,a,v;if(c.copy(r),c.vsub(i,c),u.conjugate(d),d.vmult(c,c),n.pointIsInside(c)){for(n.worldVerticesNeedsUpdate&&n.computeWorldVertices(i,u),n.worldFaceNormalsNeedsUpdate&&n.computeWorldFaceNormals(u),l=0,nt=n.faces.length;l!==nt;l++)tt=[n.worldVertices[n.faces[l][0]]],w=n.worldFaceNormals[l],r.vsub(tt[0],g),b=-w.dot(g),(y===null||Math.abs(b)<Math.abs(y))&&(y=b,k=l,p.copy(w),it++);k!==-1?(s=this.createContactEquation(o,e,t,n),p.mult(y,h),h.vadd(r,h),h.vsub(i,h),s.rj.copy(h),p.negate(s.ni),s.ri.set(0,0,0),a=s.ri,v=s.rj,a.vadd(r,a),a.vsub(o.position,a),v.vadd(i,v),v.vsub(e.position,v),this.result.push(s),this.createFrictionEquationsFromContact(s,this.frictionResult)):console.warn("Point found inside convex, but did not find penetrating face!")}};r.prototype[u.types.BOX|u.types.HEIGHTFIELD]=r.prototype.boxHeightfield=function(n,t,i,r,u,f,e,o){n.convexPolyhedronRepresentation.material=n.material;n.convexPolyhedronRepresentation.collisionResponse=n.collisionResponse;this.convexHeightfield(n.convexPolyhedronRepresentation,t,i,r,u,f,e,o)};var gr=new i,nu=new i,tu=[0];r.prototype[u.types.CONVEXPOLYHEDRON|u.types.HEIGHTFIELD]=r.prototype.convexHeightfield=function(n,t,i,r,u,e,o,s){var h=t.data,d=t.elementSize,p=n.boundingSphereRadius,w=nu,nt=tu,c=gr,g,tt,it,b,k;f.pointToLocalFrame(r,e,i,c);var l=Math.floor((c.x-p)/d)-1,a=Math.ceil((c.x+p)/d)+1,v=Math.floor((c.y-p)/d)-1,y=Math.ceil((c.y+p)/d)+1;if(!(a<0)&&!(y<0)&&!(l>h.length)&&!(v>h[0].length)&&(l<0&&(l=0),a<0&&(a=0),v<0&&(v=0),y<0&&(y=0),l>=h.length&&(l=h.length-1),a>=h.length&&(a=h.length-1),y>=h[0].length&&(y=h[0].length-1),v>=h[0].length&&(v=h[0].length-1),g=[],t.getRectMinMax(l,v,a,y,g),tt=g[0],it=g[1],!(c.z-p>it)&&!(c.z+p<tt)))for(b=l;b<a;b++)for(k=v;k<y;k++)t.getConvexTrianglePillar(b,k,!1),f.pointToWorldFrame(r,e,t.pillarOffset,w),i.distanceTo(w)<t.pillarConvex.boundingSphereRadius+n.boundingSphereRadius&&this.convexConvex(n,t.pillarConvex,i,w,u,e,o,s,null,null,nt,null),t.getConvexTrianglePillar(b,k,!0),f.pointToWorldFrame(r,e,t.pillarOffset,w),i.distanceTo(w)<t.pillarConvex.boundingSphereRadius+n.boundingSphereRadius&&this.convexConvex(n,t.pillarConvex,i,w,u,e,o,s,null,null,nt,null)};nt=new i;tt=new i;r.prototype[u.types.SPHERE|u.types.HEIGHTFIELD]=r.prototype.sphereHeightfield=function(n,t,i,r,u,e,o,s){var h=t.data,y=n.radius,d=t.elementSize,p=tt,l=nt,g,rt,ut,it,b,k,ft,et;f.pointToLocalFrame(r,e,i,l);var a=Math.floor((l.x-y)/d)-1,v=Math.ceil((l.x+y)/d)+1,w=Math.floor((l.y-y)/d)-1,c=Math.ceil((l.y+y)/d)+1;if(!(v<0)&&!(c<0)&&!(a>h.length)&&!(c>h[0].length)&&(a<0&&(a=0),v<0&&(v=0),w<0&&(w=0),c<0&&(c=0),a>=h.length&&(a=h.length-1),v>=h.length&&(v=h.length-1),c>=h[0].length&&(c=h[0].length-1),w>=h[0].length&&(w=h[0].length-1),g=[],t.getRectMinMax(a,w,v,c,g),rt=g[0],ut=g[1],!(l.z-y>ut)&&!(l.z+y<rt)))for(it=this.result,b=a;b<v;b++)for(k=w;k<c;k++)if(ft=it.length,t.getConvexTrianglePillar(b,k,!1),f.pointToWorldFrame(r,e,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+n.boundingSphereRadius&&this.sphereConvex(n,t.pillarConvex,i,p,u,e,o,s),t.getConvexTrianglePillar(b,k,!0),f.pointToWorldFrame(r,e,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+n.boundingSphereRadius&&this.sphereConvex(n,t.pillarConvex,i,p,u,e,o,s),et=it.length-ft,et>2)return}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(n,t){function i(){a.apply(this);this.dt=-1;this.allowSleep=!1;this.contacts=[];this.frictionEquations=[];this.quatNormalizeSkip=0;this.quatNormalizeFast=!1;this.time=0;this.stepnumber=0;this.default_dt=1/60;this.nextId=0;this.gravity=new u;this.broadphase=new tt;this.bodies=[];this.solver=new p;this.constraints=[];this.narrowphase=new w(this);this.collisionMatrix=new v;this.collisionMatrixPrevious=new v;this.materials=[];this.contactmaterials=[];this.contactMaterialTable=new d;this.defaultMaterial=new b("default");this.defaultContactMaterial=new k(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0});this.doProfiling=!1;this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0};this.subsystems=[];this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null}}var c,y;t.exports=i;var l=n("../shapes/Shape"),u=n("../math/Vec3"),s=n("../math/Quaternion"),p=n("../solver/GSSolver"),lt=n("../utils/Vec3Pool"),at=n("../equations/ContactEquation"),vt=n("../equations/FrictionEquation"),w=n("./Narrowphase"),a=n("../utils/EventTarget"),v=n("../collision/ArrayCollisionMatrix"),b=n("../material/Material"),k=n("../material/ContactMaterial"),r=n("../objects/Body"),d=n("../utils/TupleDictionary"),g=n("../collision/RaycastResult"),nt=n("../collision/AABB"),e=n("../collision/Ray"),tt=n("../collision/NaiveBroadphase");i.prototype=new a;var yt=new nt,h=new e;i.prototype.getContactMaterial=function(n,t){return this.contactMaterialTable.get(n.id,t.id)};i.prototype.numObjects=function(){return this.bodies.length};i.prototype.collisionMatrixTick=function(){var n=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix;this.collisionMatrix=n;this.collisionMatrix.reset()};i.prototype.add=i.prototype.addBody=function(n){this.bodies.indexOf(n)===-1&&(n.index=this.bodies.length,this.bodies.push(n),n.world=this,n.initPosition.copy(n.position),n.initVelocity.copy(n.velocity),n.timeLastSleepy=this.time,n instanceof r&&(n.initAngularVelocity.copy(n.angularVelocity),n.initQuaternion.copy(n.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=n,this.dispatchEvent(this.addBodyEvent))};i.prototype.addConstraint=function(n){this.constraints.push(n)};i.prototype.removeConstraint=function(n){var t=this.constraints.indexOf(n);t!==-1&&this.constraints.splice(t,1)};i.prototype.rayTest=function(n,t,i){i instanceof g?this.raycastClosest(n,t,{skipBackfaces:!0},i):this.raycastAll(n,t,{skipBackfaces:!0},i)};i.prototype.raycastAll=function(n,t,i,r){return i.mode=e.ALL,i.from=n,i.to=t,i.callback=r,h.intersectWorld(this,i)};i.prototype.raycastAny=function(n,t,i,r){return i.mode=e.ANY,i.from=n,i.to=t,i.result=r,h.intersectWorld(this,i)};i.prototype.raycastClosest=function(n,t,i,r){return i.mode=e.CLOSEST,i.from=n,i.to=t,i.result=r,h.intersectWorld(this,i)};i.prototype.remove=function(n){var t;n.world=null;var u=this.bodies.length-1,i=this.bodies,r=i.indexOf(n);if(r!==-1){for(i.splice(r,1),t=0;t!==i.length;t++)i[t].index=t;this.collisionMatrix.setNumObjects(u);this.removeBodyEvent.body=n;this.dispatchEvent(this.removeBodyEvent)}};i.prototype.removeBody=i.prototype.remove;i.prototype.addMaterial=function(n){this.materials.push(n)};i.prototype.addContactMaterial=function(n){this.contactmaterials.push(n);this.contactMaterialTable.set(n.materials[0].id,n.materials[1].id,n)};typeof performance=="undefined"&&(performance={});performance.now||(c=Date.now(),performance.timing&&performance.timing.navigationStart&&(c=performance.timing.navigationStart),performance.now=function(){return Date.now()-c});y=new u;i.prototype.step=function(n,t,i){var f,h,s,o,u;if(i=i||10,t=t||0,t===0)this.internalStep(n),this.time+=n;else{for(f=Math.floor((this.time+t)/n)-Math.floor(this.time/n),f=Math.min(f,i),h=performance.now(),s=0;s!==f;s++)if(this.internalStep(n),performance.now()-h>n*1e3)break;this.time+=t;var l=this.time%n,a=l/n,e=y,c=this.bodies;for(o=0;o!==c.length;o++)u=c[o],u.type!==r.STATIC&&u.sleepState!==r.SLEEPING?(u.position.vsub(u.previousPosition,e),e.scale(a,e),u.position.vadd(e,u.interpolatedPosition)):(u.interpolatedPosition.copy(u.position),u.interpolatedQuaternion.copy(u.quaternion))}};var it={type:"postStep"},rt={type:"preStep"},f={type:"collide",body:null,contact:null},ut=[],ft=[],et=[],ot=[],pt=new u,wt=new u,bt=new u,kt=new u,dt=new u,gt=new u,ni=new u,ti=new u,ii=new u,st=new s,ht=new s,ct=new s,o=new u;i.prototype.internalStep=function(n){var yt,pt,si,gt,hi,ci,t,li,bt,vi,yi,pi,wi,bi,wt,e,h,ki,di,ni,gi,ti,kt,nr,i,fi;this.dt=n;var lr=this,ar=this,b=this.contacts,v=et,k=ot,y=this.numObjects(),p=this.bodies,g=this.solver,at=this.gravity,a=this.doProfiling,nt=this.profile,ei=r.DYNAMIC,c,vt=this.constraints,oi=ft,vr=at.norm(),ir=at.x,rr=at.y,ur=at.z,t=0;for(a&&(c=performance.now()),t=0;t!==y;t++)i=p[t],i.type&ei&&(yt=i.force,pt=i.mass,yt.x+=pt*ir,yt.y+=pt*rr,yt.z+=pt*ur);for(t=0,si=this.subsystems.length;t!==si;t++)this.subsystems[t].update();for(a&&(c=performance.now()),v.length=0,k.length=0,this.broadphase.collisionPairs(this,v,k),a&&(nt.broadphase=performance.now()-c),wt=vt.length,t=0;t!==wt;t++)if(e=vt[t],!e.collideConnected)for(h=v.length-1;h>=0;h-=1)(e.bodyA===v[h]&&e.bodyB===k[h]||e.bodyB===v[h]&&e.bodyA===k[h])&&(v.splice(h,1),k.splice(h,1));for(this.collisionMatrixTick(),a&&(c=performance.now()),gt=ut,hi=b.length,t=0;t!==hi;t++)gt.push(b[t]);for(b.length=0,ci=this.frictionEquations.length,t=0;t!==ci;t++)oi.push(this.frictionEquations[t]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(v,k,this,b,gt,this.frictionEquations,oi),a&&(nt.narrowphase=performance.now()-c),a&&(c=performance.now()),t=0;t<this.frictionEquations.length;t++)g.addEquation(this.frictionEquations[t]);for(li=b.length,bt=0;bt!==li;bt++){var e=b[bt],i=e.bi,u=e.bj,yr=e.si,pr=e.sj,ai;ai=i.material&&u.material?this.getContactMaterial(i.material,u.material)||this.defaultContactMaterial:this.defaultContactMaterial;vi=ai.friction;i.material&&u.material&&(i.material.friction>=0&&u.material.friction>=0&&(vi=i.material.friction*u.material.friction),i.material.restitution>=0&&u.material.restitution>=0&&(e.restitution=i.material.restitution*u.material.restitution));g.addEquation(e);i.allowSleep&&i.type===r.DYNAMIC&&i.sleepState===r.SLEEPING&&u.sleepState===r.AWAKE&&u.type!==r.STATIC&&(yi=u.velocity.norm2()+u.angularVelocity.norm2(),pi=Math.pow(u.sleepSpeedLimit,2),yi>=pi*2&&(i._wakeUpAfterNarrowphase=!0));u.allowSleep&&u.type===r.DYNAMIC&&u.sleepState===r.SLEEPING&&i.sleepState===r.AWAKE&&i.type!==r.STATIC&&(wi=i.velocity.norm2()+i.angularVelocity.norm2(),bi=Math.pow(i.sleepSpeedLimit,2),wi>=bi*2&&(u._wakeUpAfterNarrowphase=!0));this.collisionMatrix.set(i,u,!0);this.collisionMatrixPrevious.get(i,u)||(f.body=u,f.contact=e,i.dispatchEvent(f),f.body=i,u.dispatchEvent(f))}for(a&&(nt.makeContactConstraints=performance.now()-c,c=performance.now()),t=0;t!==y;t++)i=p[t],i._wakeUpAfterNarrowphase&&(i.wakeUp(),i._wakeUpAfterNarrowphase=!1);for(wt=vt.length,t=0;t!==wt;t++)for(e=vt[t],e.update(),h=0,ki=e.equations.length;h!==ki;h++)di=e.equations[h],g.addEquation(di);for(g.solve(n,this),a&&(nt.solve=performance.now()-c),g.removeAllEquations(),ni=Math.pow,t=0;t!==y;t++)i=p[t],i.type&ei&&(gi=ni(1-i.linearDamping,n),ti=i.velocity,ti.mult(gi,ti),kt=i.angularVelocity,kt&&(nr=ni(1-i.angularDamping,n),kt.mult(nr,kt)));for(this.dispatchEvent(rt),t=0;t!==y;t++)i=p[t],i.preStep&&i.preStep.call(i);a&&(c=performance.now());var wr=st,tr=ht,tt=ct,fr=this.stepnumber,er=r.DYNAMIC|r.KINEMATIC,or=fr%(this.quatNormalizeSkip+1)==0,sr=this.quatNormalizeFast,dt=n*.5,br=l.types.PLANE,kr=l.types.CONVEXPOLYHEDRON;for(t=0;t!==y;t++){var s=p[t],ii=s.force,hr=s.torque;if(s.type&er&&s.sleepState!==r.SLEEPING){var d=s.velocity,lt=s.angularVelocity,ri=s.position,w=s.quaternion,ui=s.invMass,cr=s.invInertiaWorld;d.x+=ii.x*ui*n;d.y+=ii.y*ui*n;d.z+=ii.z*ui*n;s.angularVelocity&&(cr.vmult(hr,o),o.mult(n,o),o.vadd(lt,lt));ri.x+=d.x*n;ri.y+=d.y*n;ri.z+=d.z*n;s.angularVelocity&&(tr.set(lt.x,lt.y,lt.z,0),tr.mult(w,tt),w.x+=dt*tt.x,w.y+=dt*tt.y,w.z+=dt*tt.z,w.w+=dt*tt.w,or&&(sr?w.normalizeFast():w.normalize()));s.aabb&&(s.aabbNeedsUpdate=!0);s.updateInertiaWorld&&s.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,a&&(nt.integrate=performance.now()-c),this.time+=n,this.stepnumber+=1,this.dispatchEvent(it),t=0;t!==y;t++)i=p[t],fi=i.postStep,fi&&fi.call(i);if(this.allowSleep)for(t=0;t!==y;t++)p[t].sleepTick(this.time)};i.prototype.clearForces=function(){for(var i=this.bodies,r=i.length,t=0;t!==r;t++){var n=i[t],u=n.force,f=n.torque;n.force.set(0,0,0);n.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)});
//# sourceMappingURL=cannon.min.js.map
